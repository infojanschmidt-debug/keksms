<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OnlyKeks ‚Äì Keks Konfigurator</title>
  <meta name="description" content="Gestalte deinen Keks in Mini-Steps: Text ‚Üí Look ‚Üí Extras. Live Preview, Presets, Random, Teilen." />
  <style>
    :root{
      --ink:#0b1b2a;
      --muted:#4b5b6b;
      --card: rgba(255,255,255,.78);
      --card2: rgba(255,255,255,.62);
      --line: rgba(11,27,42,.12);
      --shadow: 0 18px 60px rgba(11,27,42,.12);

      /* Pastell-Himmel + pink */
      --sky1:#ffe6f2;
      --sky2:#ffd3ea;
      --sky3:#fff4ea;
      --pink:#ff4fa3;
      --pink2:#ff7cc5;

      /* Cookie colors */
      --cookie1:#e9c7a2;
      --cookie2:#d9ad7f;
      --cookie3:#c79363;

      --radius: 22px;
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 15% 15%, rgba(255,79,163,.16), transparent 60%),
        radial-gradient(900px 500px at 85% 20%, rgba(255,124,197,.14), transparent 55%),
        linear-gradient(180deg, var(--sky1), var(--sky2), var(--sky3));
      min-height:100vh;
    }

    .wrap{max-width:1100px;margin:0 auto;padding:22px 16px 110px}
    header{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      padding:6px 6px 14px;
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:950; letter-spacing:.2px;}
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: radial-gradient(circle at 30% 30%, #fff, rgba(255,255,255,.4) 40%, rgba(255,79,163,.25) 70%),
                linear-gradient(135deg, rgba(255,255,255,.9), rgba(255,255,255,.5));
      box-shadow: 0 12px 30px rgba(255,79,163,.18);
      position:relative; overflow:hidden;
    }
    .logo:after{content:"üç™"; position:absolute; inset:0; display:grid; place-items:center; font-size:22px; transform: translateY(1px);}
    .sub{color:var(--muted); font-weight:650; font-size:13px}

    .pill{
      display:inline-flex; align-items:center; gap:8px;
      font-size:12px; font-weight:850; color:rgba(11,27,42,.75);
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(11,27,42,.10);
      background: rgba(255,255,255,.55);
      white-space:nowrap;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns:1fr;}
    }

    .card{
      background: var(--card);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    .card .hd{
      padding:14px 16px 10px;
      display:flex; justify-content:space-between; align-items:flex-start; gap:12px;
    }
    .title{font-size:18px;font-weight:950;line-height:1.2}
    .small{font-size:12px; color:var(--muted); font-weight:650}

    /* Stepper */
    .stepsTop{
      padding:0 16px 12px;
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
    }
    .progress{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .stepDot{
      display:flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(11,27,42,.10);
      background: rgba(255,255,255,.58);
      font-weight:900; font-size:12px;
      color: rgba(11,27,42,.68);
    }
    .stepDot.active{
      border-color: rgba(255,79,163,.45);
      color: rgba(11,27,42,.85);
      background: linear-gradient(180deg, rgba(255,79,163,.14), rgba(255,255,255,.62));
    }
    .stepDot.done{
      border-color: rgba(11,27,42,.12);
      background: rgba(255,255,255,.72);
    }
    .stepDot .n{
      width:18px; height:18px; border-radius:50%;
      display:grid; place-items:center;
      border:2px solid rgba(11,27,42,.22);
      font-size:11px;
    }
    .stepDot.active .n{border-color: rgba(255,79,163,.55)}
    .stepDot.done .n{border-color: rgba(11,27,42,.24)}
    .successHint{
      font-weight:900;
      font-size:12px;
      color: rgba(11,27,42,.72);
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(11,27,42,.10);
      background: rgba(255,255,255,.55);
    }

    .body{padding:0 16px 16px}
    label.lbl{display:block;font-size:12px;font-weight:950;color:rgba(11,27,42,.78);margin:10px 0 6px}

    textarea, select, input[type="text"]{
      width:100%;
      border:1px solid var(--line);
      border-radius: 16px;
      padding:12px 12px;
      font-size:14px;
      background: rgba(255,255,255,.72);
      outline:none;
    }
    textarea{min-height:96px; resize:vertical}

    .row{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 620px){ .row{grid-template-columns:1fr} }

    .divider{height:1px; background: rgba(11,27,42,.08); margin:12px 0}

    /* Chips + presets */
    .chips,.presetBar{display:flex; flex-wrap:wrap; gap:8px; margin-top:8px}
    .chip,.preset{
      border:1px solid rgba(11,27,42,.10);
      background: rgba(255,255,255,.6);
      padding:10px 12px;
      border-radius:999px;
      font-weight:950; font-size:12px;
      cursor:pointer;
      transition: transform .08s ease, border-color .2s ease;
    }
    .chip:active,.preset:active{transform: scale(.98)}
    .preset{
      border-color: rgba(255,79,163,.25);
      background: linear-gradient(180deg, rgba(255,79,163,.12), rgba(255,255,255,.62));
    }
    .preset:hover{border-color: rgba(255,79,163,.45)}

    /* Options cards */
    .radioGrid{display:grid; grid-template-columns: repeat(3,1fr); gap:10px}
    @media (max-width: 620px){ .radioGrid{grid-template-columns:1fr} }

    .opt{
      border:1px solid rgba(11,27,42,.10);
      background: rgba(255,255,255,.60);
      border-radius: 18px;
      padding:12px;
      cursor:pointer;
      display:flex; gap:10px; align-items:flex-start;
      transition: transform .08s ease, border-color .2s ease;
    }
    .opt:active{transform:scale(.99)}
    .opt.active{border-color: rgba(255,79,163,.45)}
    .dot{
      width:14px;height:14px;border-radius:50%;
      border:2px solid rgba(11,27,42,.28);
      margin-top:2px;
      flex:0 0 auto;
      position:relative;
    }
    .opt.active .dot{border-color: rgba(255,79,163,.65)}
    .opt.active .dot:after{content:""; position:absolute; inset:3px; border-radius:50%; background: rgba(255,79,163,.75);}
    .opt .t{font-weight:950; font-size:13px}
    .opt .d{font-size:12px; color:rgba(11,27,42,.62); font-weight:650; margin-top:2px}

    /* Range */
    .range{display:grid; grid-template-columns: 1fr auto; gap:10px; align-items:center}
    input[type="range"]{width:100%}

    /* Buttons */
    .btn{
      border:1px solid rgba(11,27,42,.12);
      background: rgba(255,255,255,.72);
      border-radius: 16px;
      padding:12px 14px;
      font-weight:950;
      cursor:pointer;
      display:inline-flex; align-items:center; justify-content:center; gap:10px;
      transition: transform .08s ease, box-shadow .2s ease, border-color .2s ease;
      min-height:44px;
    }
    .btn:active{transform: scale(.98)}
    .btn.primary{
      border-color: rgba(255,79,163,.35);
      background: linear-gradient(180deg, rgba(255,79,163,.18), rgba(255,255,255,.76));
      box-shadow: 0 14px 30px rgba(255,79,163,.18);
    }
    .btn.danger{border-color: rgba(255,0,0,.18)}
    .btn[disabled]{opacity:.5; cursor:not-allowed}

    /* Preview */
    .previewWrap{padding:16px}
    .stage{
      background: var(--card2);
      border: 1px dashed rgba(11,27,42,.16);
      border-radius: var(--radius);
      padding:18px;
      display:grid;
      place-items:center;
      position:relative;
      overflow:hidden;
      min-height: 420px;
    }
    .stage:before{
      content:"";
      position:absolute; inset:-60px -60px auto auto;
      width:220px; height:220px;
      background: radial-gradient(circle at 30% 30%, rgba(255,79,163,.18), transparent 62%);
      transform: rotate(18deg);
    }
    .hint{
      position:absolute; left:16px; top:16px;
      font-size:12px; font-weight:950;
      color:rgba(11,27,42,.55);
      background: rgba(255,255,255,.55);
      border:1px solid rgba(11,27,42,.10);
      padding:8px 10px;
      border-radius:999px;
    }

    .mini{
      display:flex; gap:10px; align-items:center; justify-content:space-between;
      padding:12px 16px 14px;
      border-top:1px solid rgba(11,27,42,.08);
      flex-wrap:wrap;
    }
    .kpi{display:flex; gap:10px; flex-wrap:wrap; align-items:center; color:rgba(11,27,42,.72); font-weight:900; font-size:12px;}
    .tag{padding:8px 10px;border-radius:999px; border:1px solid rgba(11,27,42,.10); background: rgba(255,255,255,.55);}

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:88px; transform:translateX(-50%);
      background: rgba(255,255,255,.85);
      border:1px solid rgba(11,27,42,.12);
      border-radius:999px;
      padding:10px 14px;
      box-shadow: 0 18px 50px rgba(11,27,42,.14);
      font-weight:950; font-size:12px;
      opacity:0; pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index:99;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-6px)}

    /* Micro animations */
    @keyframes pop { 0%{transform:scale(.92);opacity:0} 60%{transform:scale(1.06);opacity:1} 100%{transform:scale(1);opacity:1} }
    @keyframes fadeUp { 0%{opacity:0;transform:translateY(4px)} 100%{opacity:1;transform:translateY(0)} }
    #sprinkleLayer.anim, #stickerLayer.anim{transform-origin:180px 180px; animation: pop .22s ease-out;}
    #textLayer.anim{transform-origin:180px 210px; animation: fadeUp .18s ease-out;}

    /* Step panels */
    .panel{display:none;}
    .panel.active{display:block;}

    /* Mobile thumb: sticky bottom bar */
    .bottomBar{
      position:fixed; left:0; right:0; bottom:0;
      background: rgba(255,255,255,.82);
      border-top:1px solid rgba(11,27,42,.12);
      backdrop-filter: blur(10px);
      padding:10px 12px calc(10px + env(safe-area-inset-bottom));
      z-index:100;
    }
    .bottomInner{
      max-width:1100px;
      margin:0 auto;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    .bottomInner .left, .bottomInner .right{display:flex; gap:10px; align-items:center; flex-wrap:wrap;}
    .bottomInner .btn{min-width:110px}
    .bottomMeta{
      font-size:12px;
      font-weight:900;
      color: rgba(11,27,42,.72);
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(11,27,42,.10);
      background: rgba(255,255,255,.55);
      white-space:nowrap;
    }

    /* Make mobile less scroll-chaos: preview first */
    @media (max-width: 920px){
      .wrap{padding-bottom:140px;}
      .stage{min-height:360px;}
      .hint{display:none;}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div style="font-size:18px;font-weight:950;line-height:1.1">OnlyKeks</div>
          <div class="sub">Mini-Steps ¬∑ Live Preview ¬∑ Presets ¬∑ Teilen</div>
        </div>
      </div>
      <div class="pill" title="Speichert lokal im Browser">üîí Entwurf wird lokal gespeichert</div>
    </header>

    <div class="grid">
      <!-- Left: Stepper + Controls -->
      <section class="card" aria-label="Konfigurator">
        <div class="hd">
          <div>
            <div class="title">Gestalte deinen Keks</div>
            <div class="small">Erst Emotion, dann Upsell: Text ‚Üí Look ‚Üí Extras.</div>
          </div>
          <div class="pill" id="stepTitle">Step 1/3 ¬∑ Text</div>
        </div>

        <div class="stepsTop">
          <div class="progress" aria-label="Fortschritt">
            <div class="stepDot" id="dot1"><span class="n">1</span> Text</div>
            <div class="stepDot" id="dot2"><span class="n">2</span> Look</div>
            <div class="stepDot" id="dot3"><span class="n">3</span> Extras</div>
          </div>
          <div class="successHint" id="successHint">Kurz & s√º√ü wirkt am besten üç™</div>
        </div>

        <div class="body">

          <!-- STEP 1: TEXT -->
          <div class="panel" id="p1">
            <label class="lbl" for="msg">Deine Message (kommt auf den Keks)</label>
            <textarea id="msg" maxlength="140" placeholder="z.B. ‚ÄûDu schaffst das! üç™‚Äú"></textarea>

            <div class="row">
              <div>
                <div class="small" style="margin-top:8px;">
                  <b id="charCount">0</b>/140 Zeichen ¬∑ <span style="font-weight:900">kurz & s√º√ü</span> wirkt am besten.
                </div>
              </div>
              <div style="display:flex; justify-content:flex-end; align-items:center; margin-top:8px;">
                <span class="pill" id="charHint">Perfekt.</span>
              </div>
            </div>

            <div class="chips" id="chips">
              <button class="chip" data-msg="Ich denk an dich üíó">Ich denk an dich</button>
              <button class="chip" data-msg="Du schaffst das. Weiter. üí™">Motivation</button>
              <button class="chip" data-msg="Happy Birthday, du Legende! ü•≥">Birthday</button>
              <button class="chip" data-msg="Danke dir! üôèüç™">Danke</button>
              <button class="chip" data-msg="Beweg deinen Arsch üòÑ">Frech</button>
            </div>

            <div class="divider"></div>
            <div class="small">Wenn du willst: Im n√§chsten Step machst du den Look ‚Äûwow‚Äú. Kein Stress.</div>
          </div>

          <!-- STEP 2: LOOK -->
          <div class="panel" id="p2">
            <div class="small">Vorauswahl ist schon h√ºbsch. Du optimierst nur noch.</div>

            <div class="divider"></div>

            <div style="font-weight:950; font-size:14px; margin:6px 0 6px;">üéõÔ∏è Presets (1 Klick = sch√∂ner Keks)</div>
            <div class="presetBar" id="presetBar">
              <button class="preset" data-preset="love">üíó Liebe</button>
              <button class="preset" data-preset="sassy">üòà Frech</button>
              <button class="preset" data-preset="birthday">ü•≥ Birthday</button>
              <button class="preset" data-preset="motivation">üí™ Motivation</button>
              <button class="preset" data-preset="thanks">üôè Danke</button>
              <button class="preset" data-preset="party">üéâ Party</button>
              <button class="preset" data-preset="cute">üéÄ S√º√ü</button>
            </div>

            <div class="divider"></div>

            <div class="row">
              <div>
                <div style="font-weight:950; font-size:14px; margin:6px 0 6px;">üç™ Form</div>
                <div class="radioGrid" id="shapeGrid">
                  <div class="opt" data-shape="round">
                    <div class="dot"></div>
                    <div><div class="t">Rund</div><div class="d">Klassisch, safe.</div></div>
                  </div>
                  <div class="opt" data-shape="heart">
                    <div class="dot"></div>
                    <div><div class="t">Herz</div><div class="d">Mehr Gef√ºhl.</div></div>
                  </div>
                  <div class="opt" data-shape="star">
                    <div class="dot"></div>
                    <div><div class="t">Stern</div><div class="d">Party-Vibe.</div></div>
                  </div>
                </div>
              </div>

              <div>
                <div style="font-weight:950; font-size:14px; margin:6px 0 6px;">üéÄ Icing</div>
                <label class="lbl" for="icing">Farbe</label>
                <select id="icing">
                  <option value="none">Ohne (pur)</option>
                  <option value="pink">Pinky Gloss</option>
                  <option value="vanilla">Vanilla Cream</option>
                  <option value="choco">Choco Drip</option>
                  <option value="mint">Minty Fresh</option>
                </select>

                <label class="lbl" for="drip">Style</label>
                <select id="drip">
                  <option value="smooth">Glatt</option>
                  <option value="drip">Drip</option>
                  <option value="zigzag">Zigzag</option>
                </select>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row">
              <div>
                <div style="font-weight:950; font-size:14px; margin:6px 0 6px;">üåà Sprinkles</div>
                <label class="lbl" for="sprinkles">Typ</label>
                <select id="sprinkles">
                  <option value="none">Keine</option>
                  <option value="dots">Dots</option>
                  <option value="stars">Mini-Sterne</option>
                  <option value="confetti">Konfetti</option>
                </select>

                <div class="range">
                  <div>
                    <label class="lbl" for="sprinkleAmt">Menge</label>
                    <input id="sprinkleAmt" type="range" min="0" max="100" value="55" />
                  </div>
                  <div class="pill" id="sprinkleLabel">55%</div>
                </div>
              </div>

              <div>
                <div style="font-weight:950; font-size:14px; margin:6px 0 6px;">üß∑ Sticker</div>
                <label class="lbl" for="sticker">Motiv</label>
                <select id="sticker">
                  <option value="none">Keiner</option>
                  <option value="bow">Schleife</option>
                  <option value="heart">Herz</option>
                  <option value="sparkle">Glitzer</option>
                  <option value="smile">Smiley</option>
                </select>

                <div class="range">
                  <div>
                    <label class="lbl" for="stickerSize">Gr√∂√üe</label>
                    <input id="stickerSize" type="range" min="60" max="140" value="100" />
                  </div>
                  <div class="pill" id="stickerLabel">100%</div>
                </div>
              </div>
            </div>

            <div class="divider"></div>

            <div class="row">
              <button class="btn primary" id="random" type="button">üé≤ √úberrasch mich üç™</button>
              <button class="btn" id="copyJson" type="button">üìã JSON kopieren</button>
            </div>
          </div>

          <!-- STEP 3: EXTRAS (4) -->
          <div class="panel" id="p3">
            <div class="small">Erst war‚Äôs s√º√ü ‚Äì jetzt machen wir‚Äôs ‚ÄûGeschenk-ready‚Äú.</div>

            <div class="divider"></div>

            <div class="row">
              <div>
                <div style="font-weight:950; font-size:14px; margin:6px 0 6px;">üéÅ Geschenk-Box</div>
                <select id="giftBox">
                  <option value="none">Ohne Box (Standard)</option>
                  <option value="soft">Soft-Box (s√º√ü & sicher)</option>
                  <option value="premium">Premium-Box (Wow-Faktor)</option>
                </select>

                <label class="lbl" for="giftWrap">Karte / Schleife</label>
                <select id="giftWrap">
                  <option value="card">Karte + QR (Standard)</option>
                  <option value="card_note">Karte + Mini-Notiz</option>
                  <option value="card_bow">Karte + Schleife</option>
                </select>
              </div>

              <div>
                <div style="font-weight:950; font-size:14px; margin:6px 0 6px;">üöö Versand</div>
                <select id="shipping">
                  <option value="standard">Standard (g√ºnstig)</option>
                  <option value="tracked">Tracking (empfohlen)</option>
                  <option value="express">Express (schnell)</option>
                </select>

                <label class="lbl" for="note">Extra-Hinweis (optional)</label>
                <input id="note" type="text" maxlength="80" placeholder="z.B. ‚ÄöBitte nicht knicken‚Äò" />
              </div>
            </div>

            <div class="divider"></div>

            <div class="row">
              <button class="btn" id="shareImg" type="button">üì§ Keks teilen (Bild)</button>
              <button class="btn primary" id="saveDraft" type="button">üíó Entwurf speichern</button>
            </div>

            <div class="divider"></div>
            <div class="small">Next Step (sp√§ter): Checkout / Adresse / Payment ‚Äì hier nur Config + Social.</div>
          </div>
        </div>
      </section>

      <!-- Right: Preview -->
      <aside class="card" aria-label="Live Preview">
        <div class="hd">
          <div>
            <div class="title">Live Preview</div>
            <div class="small">Alles, was du klickst, siehst du sofort.</div>
          </div>
          <div class="pill">üëÄ Instant</div>
        </div>

        <div class="previewWrap">
          <div class="stage">
            <div class="hint">Mobile: Buttons unten. Desktop: Preview rechts.</div>
            <svg id="cookieSvg" width="360" height="360" viewBox="0 0 360 360" role="img" aria-label="Keks Vorschau">
              <defs>
                <radialGradient id="cookieGrad" cx="30%" cy="25%" r="70%">
                  <stop offset="0%" stop-color="var(--cookie1)" />
                  <stop offset="55%" stop-color="var(--cookie2)" />
                  <stop offset="100%" stop-color="var(--cookie3)" />
                </radialGradient>

                <filter id="softShadow" x="-30%" y="-30%" width="160%" height="160%">
                  <feDropShadow dx="0" dy="18" stdDeviation="14" flood-color="rgba(11,27,42,.20)"/>
                </filter>

                <filter id="gloss" x="-30%" y="-30%" width="160%" height="160%">
                  <feGaussianBlur stdDeviation="6" result="b"/>
                  <feColorMatrix in="b" type="matrix"
                    values="1 0 0 0 0
                            0 1 0 0 0
                            0 0 1 0 0
                            0 0 0 .35 0" result="c"/>
                  <feMerge>
                    <feMergeNode in="c"/>
                    <feMergeNode in="SourceGraphic"/>
                  </feMerge>
                </filter>
              </defs>

              <g id="cookieBase" filter="url(#softShadow)"></g>
              <g id="icingLayer"></g>
              <g id="sprinkleLayer"></g>
              <g id="stickerLayer"></g>
              <g id="textLayer"></g>
            </svg>
          </div>
        </div>

        <div class="mini">
          <div class="kpi">
            <span class="tag">Form: <b id="kShape">Rund</b></span>
            <span class="tag">Icing: <b id="kIcing">Pinky</b></span>
            <span class="tag">Sprinkles: <b id="kSpr">Dots</b></span>
          </div>
          <span class="pill" id="previewMeta">Ready üç™</span>
        </div>
      </aside>
    </div>
  </div>

  <!-- Sticky bottom controls (5) -->
  <div class="bottomBar" role="navigation" aria-label="Step Navigation">
    <div class="bottomInner">
      <div class="left">
        <span class="bottomMeta" id="bottomMeta">Step 1/3</span>
        <button class="btn" id="backBtn" type="button" disabled>‚Üê Zur√ºck</button>
      </div>
      <div class="right">
        <button class="btn danger" id="resetBtn" type="button">üßΩ Reset</button>
        <button class="btn primary" id="nextBtn" type="button">Weiter ‚Üí</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Gespeichert üç™</div>

  <script>
    // ---------- Helpers ----------
    const $ = (id)=>document.getElementById(id);
    const rand = (a,b)=>Math.floor(Math.random()*(b-a+1))+a;
    const pick = (arr)=>arr[Math.floor(Math.random()*arr.length)];
    function escapeXml(s){ return s.replace(/[<>&'"]/g, (c)=>({ "<":"&lt;", ">":"&gt;", "&":"&amp;", "'":"&apos;", '"':"&quot;" }[c])); }

    function toast(txt){
      ui.toast.textContent = txt;
      ui.toast.classList.add("show");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>ui.toast.classList.remove("show"), 1400);
    }

    // ---------- UI ----------
    const ui = {
      // stepper
      stepTitle: $("stepTitle"),
      dot1: $("dot1"), dot2: $("dot2"), dot3: $("dot3"),
      successHint: $("successHint"),
      bottomMeta: $("bottomMeta"),
      backBtn: $("backBtn"),
      nextBtn: $("nextBtn"),
      resetBtn: $("resetBtn"),

      // panels
      p1: $("p1"), p2: $("p2"), p3: $("p3"),

      // step1
      msg: $("msg"),
      chips: $("chips"),
      charCount: $("charCount"),
      charHint: $("charHint"),

      // step2
      presetBar: $("presetBar"),
      shapeGrid: $("shapeGrid"),
      icing: $("icing"),
      drip: $("drip"),
      sprinkles: $("sprinkles"),
      sprinkleAmt: $("sprinkleAmt"),
      sprinkleLabel: $("sprinkleLabel"),
      sticker: $("sticker"),
      stickerSize: $("stickerSize"),
      stickerLabel: $("stickerLabel"),
      random: $("random"),
      copyJson: $("copyJson"),

      // step3 extras
      giftBox: $("giftBox"),
      giftWrap: $("giftWrap"),
      shipping: $("shipping"),
      note: $("note"),
      shareImg: $("shareImg"),
      saveDraft: $("saveDraft"),

      // preview
      cookieSvg: $("cookieSvg"),
      cookieBase: $("cookieBase"),
      icingLayer: $("icingLayer"),
      sprinkleLayer: $("sprinkleLayer"),
      stickerLayer: $("stickerLayer"),
      textLayer: $("textLayer"),
      kShape: $("kShape"),
      kIcing: $("kIcing"),
      kSpr: $("kSpr"),
      previewMeta: $("previewMeta"),

      toast: $("toast"),
    };

    // ---------- State ----------
    const LS_KEY = "onlykeks_stepper_v1";
    const defaultState = {
      step: 1,

      // (2) Vorauswahl statt leer
      msg: "Ich denk an dich üíó",
      shape: "heart",
      icing: "pink",
      drip: "smooth",
      sprinkles: "dots",
      sprinkleAmt: 55,
      sticker: "bow",
      stickerSize: 115,

      // (4) Extras NACH dem Keks
      extras: {
        giftBox: "none",
        giftWrap: "card",
        shipping: "tracked",
        note: ""
      }
    };

    let state = loadDraft() ?? structuredClone(defaultState);
    let lastState = structuredClone(state);

    function saveLocal(){ localStorage.setItem(LS_KEY, JSON.stringify(state)); }
    function loadDraft(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return null;
        const parsed = JSON.parse(raw);
        return parsed && typeof parsed === "object" ? parsed : null;
      }catch(e){ return null; }
    }

    function setState(patch){
      const prev = structuredClone(state);
      state = { ...state, ...patch };
      render(prev);
      saveLocal();
    }

    function setExtras(patch){
      const prev = structuredClone(state);
      state.extras = { ...state.extras, ...patch };
      render(prev);
      saveLocal();
    }

    // ---------- Presets (kuratiert) ----------
    const PRESETS = {
      love:     { shape:"heart", icing:"pink",   drip:"drip",   sprinkles:"stars",    sprinkleAmt:45, sticker:"heart",   stickerSize:115, msg:"F√ºr dich, weil du du bist üíó" },
      sassy:    { shape:"round", icing:"choco",  drip:"zigzag", sprinkles:"confetti", sprinkleAmt:65, sticker:"smile",   stickerSize:95,  msg:"Beweg deinen Arsch üòÑ" },
      birthday: { shape:"star",  icing:"vanilla",drip:"zigzag", sprinkles:"confetti", sprinkleAmt:80, sticker:"sparkle", stickerSize:125, msg:"Happy Birthday, du Legende! ü•≥" },
      motivation:{shape:"round", icing:"mint",   drip:"smooth", sprinkles:"dots",     sprinkleAmt:35, sticker:"sparkle", stickerSize:105, msg:"Du schaffst das. Weiter. üí™" },
      thanks:   { shape:"round", icing:"vanilla",drip:"smooth", sprinkles:"stars",    sprinkleAmt:25, sticker:"bow",     stickerSize:95,  msg:"Danke dir! üôèüç™" },
      party:    { shape:"star",  icing:"pink",   drip:"drip",   sprinkles:"confetti", sprinkleAmt:70, sticker:"sparkle", stickerSize:120, msg:"Heute wird‚Äôs gro√ü. üéâ" },
      cute:     { shape:"heart", icing:"pink",   drip:"smooth", sprinkles:"dots",     sprinkleAmt:55, sticker:"bow",     stickerSize:115, msg:"Ich denk an dich üíó" },
    };

    // ---------- Stepper logic ----------
    function goStep(n){
      const clamped = Math.max(1, Math.min(3, n));
      const prev = structuredClone(state);
      state.step = clamped;
      render(prev);
      saveLocal();
      // success moments
      if(clamped === 2) toast("Sieht s√º√ü aus üç™");
      if(clamped === 3) toast("Jetzt machen wir‚Äôs Geschenk-ready üéÅ");
    }

    function canNext(){
      // minimal guard: always allow next; but keep UX friendly
      return true;
    }

    ui.backBtn.addEventListener("click", ()=> goStep(state.step - 1));
    ui.nextBtn.addEventListener("click", ()=>{
      if(!canNext()) return;
      if(state.step < 3) goStep(state.step + 1);
      else toast("Fertig üç™ (Checkout kommt als n√§chstes)");
    });

    ui.resetBtn.addEventListener("click", ()=>{
      const prev = structuredClone(state);
      state = structuredClone(defaultState);
      render(prev);
      saveLocal();
      toast("Reset ‚Äì wieder sauber üç™");
    });

    // ---------- Bind Step 1 (Text + visible limit) ----------
    ui.chips.addEventListener("click", (e)=>{
      const btn = e.target.closest(".chip");
      if(!btn) return;
      ui.msg.value = btn.dataset.msg;
      setState({ msg: ui.msg.value });
    });
    ui.msg.addEventListener("input", ()=> setState({ msg: ui.msg.value }));

    // ---------- Bind Step 2 (Look) ----------
    ui.presetBar.addEventListener("click", (e)=>{
      const btn = e.target.closest(".preset");
      if(!btn) return;
      const preset = PRESETS[btn.dataset.preset];
      if(!preset) return;
      setState({ ...preset });
      syncInputsFromState();
      toast("Preset angewendet ‚ú®");
    });

    ui.shapeGrid.addEventListener("click", (e)=>{
      const opt = e.target.closest(".opt");
      if(!opt) return;
      setState({ shape: opt.dataset.shape });
    });

    ui.icing.addEventListener("change", ()=> setState({ icing: ui.icing.value }));
    ui.drip.addEventListener("change", ()=> setState({ drip: ui.drip.value }));
    ui.sprinkles.addEventListener("change", ()=> setState({ sprinkles: ui.sprinkles.value }));

    ui.sprinkleAmt.addEventListener("input", ()=>{
      ui.sprinkleLabel.textContent = ui.sprinkleAmt.value + "%";
      // smooth update
      const prev = structuredClone(state);
      state.sprinkleAmt = +ui.sprinkleAmt.value;
      render(prev);
      saveLocal();
    });

    ui.sticker.addEventListener("change", ()=> setState({ sticker: ui.sticker.value }));
    ui.stickerSize.addEventListener("input", ()=>{
      ui.stickerLabel.textContent = ui.stickerSize.value + "%";
      const prev = structuredClone(state);
      state.stickerSize = +ui.stickerSize.value;
      render(prev);
      saveLocal();
    });

    ui.random.addEventListener("click", ()=>{
      const shapes = ["round","heart","star"];
      const icings = ["none","pink","vanilla","choco","mint"];
      const drips = ["smooth","drip","zigzag"];
      const spr = ["none","dots","stars","confetti"];
      const st = ["none","bow","heart","sparkle","smile"];
      const msgs = [
        "Ich denk an dich üíó",
        "Du schaffst das. Weiter. üí™",
        "Happy Birthday, du Legende! ü•≥",
        "Danke dir! üôèüç™",
        "Beweg deinen Arsch üòÑ",
        "Komm vorbei. Jetzt. üç™",
        "Heute wird‚Äôs gro√ü. üéâ"
      ];
      setState({
        msg: pick(msgs),
        shape: pick(shapes),
        icing: pick(icings),
        drip: pick(drips),
        sprinkles: pick(spr),
        sprinkleAmt: rand(10, 90),
        sticker: pick(st),
        stickerSize: rand(70, 130)
      });
      syncInputsFromState();
      toast("√úberraschung ‚ú®");
    });

    ui.copyJson.addEventListener("click", async ()=>{
      const json = JSON.stringify(state, null, 2);
      try{ await navigator.clipboard.writeText(json); toast("JSON kopiert üìã"); }
      catch(e){ prompt("Kopieren:", json); }
    });

    // ---------- Bind Step 3 (Extras) ----------
    ui.giftBox.addEventListener("change", ()=> setExtras({ giftBox: ui.giftBox.value }));
    ui.giftWrap.addEventListener("change", ()=> setExtras({ giftWrap: ui.giftWrap.value }));
    ui.shipping.addEventListener("change", ()=> setExtras({ shipping: ui.shipping.value }));
    ui.note.addEventListener("input", ()=> setExtras({ note: ui.note.value }));

    ui.saveDraft.addEventListener("click", ()=>{
      saveLocal();
      toast("Entwurf gespeichert üç™");
    });

    ui.shareImg.addEventListener("click", async ()=>{
      try{
        ui.shareImg.disabled = true;
        const blob = await svgToPngBlob(ui.cookieSvg, 1080, 1080);
        const file = new File([blob], "onlykeks.png", { type: "image/png" });

        if(navigator.canShare && navigator.canShare({ files: [file] })){
          await navigator.share({ title:"OnlyKeks", text:"Mein Keks-Design üç™", files:[file] });
          toast("Geteilt üì§");
        } else {
          const url = URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url; a.download = "onlykeks.png";
          document.body.appendChild(a); a.click(); a.remove();
          URL.revokeObjectURL(url);
          toast("PNG gespeichert üì•");
        }
      } catch(e){
        console.error(e);
        toast("Share ging nich ‚Äì Browser zickt üòÖ");
      } finally {
        ui.shareImg.disabled = false;
      }
    });

    // ---------- SVG render ----------
    function labelShape(s){ return ({round:"Rund", heart:"Herz", star:"Stern"}[s] || "Rund"); }
    function labelIcing(i){ return ({none:"Ohne", pink:"Pinky", vanilla:"Vanilla", choco:"Choco", mint:"Mint"}[i] || "Pinky"); }
    function labelSpr(s){ return ({none:"Keine", dots:"Dots", stars:"Sterne", confetti:"Konfetti"}[s] || "Dots"); }

    function microAnim(el){
      el.classList.remove("anim");
      void el.getBoundingClientRect();
      el.classList.add("anim");
      setTimeout(()=> el.classList.remove("anim"), 260);
    }

    function render(prev){
      // Step panels
      ui.p1.classList.toggle("active", state.step === 1);
      ui.p2.classList.toggle("active", state.step === 2);
      ui.p3.classList.toggle("active", state.step === 3);

      // Step header + dots
      const titles = {1:"Text",2:"Look",3:"Extras"};
      ui.stepTitle.textContent = `Step ${state.step}/3 ¬∑ ${titles[state.step]}`;
      ui.bottomMeta.textContent = `Step ${state.step}/3`;
      ui.backBtn.disabled = state.step === 1;
      ui.nextBtn.textContent = state.step === 3 ? "Fertig" : "Weiter ‚Üí";

      ui.dot1.classList.toggle("active", state.step===1);
      ui.dot2.classList.toggle("active", state.step===2);
      ui.dot3.classList.toggle("active", state.step===3);

      ui.dot1.classList.toggle("done", state.step>1);
      ui.dot2.classList.toggle("done", state.step>2);

      // Success hint per step
      if(state.step === 1) ui.successHint.textContent = "Kurz & s√º√ü wirkt am besten üç™";
      if(state.step === 2) ui.successHint.textContent = "Sieht s√º√ü aus? Dann weiter. ‚ú®";
      if(state.step === 3) ui.successHint.textContent = "Jetzt Extras ‚Äì erst jetzt. üéÅ";

      // Char counter (3)
      const len = (state.msg || "").length;
      ui.charCount.textContent = len;
      ui.charHint.textContent =
        len < 12 ? "Kurz ‚Äì gerne 1 Satz."
        : len <= 60 ? "Perfekt: kurz & s√º√ü."
        : len <= 110 ? "Noch ok ‚Äì aber k√ºrzer wirkt st√§rker."
        : "Schon lang ‚Äì k√ºrzer wirkt besser.";

      // Sync look inputs (only if they exist in DOM - they do)
      ui.sprinkleLabel.textContent = `${state.sprinkleAmt}%`;
      ui.stickerLabel.textContent = `${state.stickerSize}%`;

      // highlight shape cards
      [...ui.shapeGrid.querySelectorAll(".opt")].forEach(el=>{
        el.classList.toggle("active", el.dataset.shape === state.shape);
      });

      // preview KPIs
      ui.kShape.textContent = labelShape(state.shape);
      ui.kIcing.textContent = labelIcing(state.icing);
      ui.kSpr.textContent = labelSpr(state.sprinkles);

      // build SVG layers
      ui.cookieBase.innerHTML = buildCookieBase(state.shape);
      ui.icingLayer.innerHTML = buildIcing(state.shape, state.icing, state.drip);
      ui.sprinkleLayer.innerHTML = buildSprinkles(state.shape, state.sprinkles, state.sprinkleAmt);
      ui.stickerLayer.innerHTML = buildSticker(state.shape, state.sticker, state.stickerSize);
      ui.textLayer.innerHTML = buildText(state.shape, state.msg);

      // Micro-animations (3)
      if(prev){
        if(prev.msg !== state.msg) microAnim(ui.textLayer);
        if(prev.sprinkles !== state.sprinkles || prev.sprinkleAmt !== state.sprinkleAmt) microAnim(ui.sprinkleLayer);
        if(prev.sticker !== state.sticker || prev.stickerSize !== state.stickerSize) microAnim(ui.stickerLayer);
      }

      // Preview meta
      if(state.step === 1) ui.previewMeta.textContent = "Text sitzt üç™";
      if(state.step === 2) ui.previewMeta.textContent = "Look knallt ‚ú®";
      if(state.step === 3) ui.previewMeta.textContent = "Geschenk-ready üéÅ";

      lastState = structuredClone(state);
    }

    function syncInputsFromState(){
      ui.msg.value = state.msg;

      ui.icing.value = state.icing;
      ui.drip.value = state.drip;
      ui.sprinkles.value = state.sprinkles;
      ui.sprinkleAmt.value = state.sprinkleAmt;
      ui.sticker.value = state.sticker;
      ui.stickerSize.value = state.stickerSize;

      ui.giftBox.value = state.extras.giftBox;
      ui.giftWrap.value = state.extras.giftWrap;
      ui.shipping.value = state.extras.shipping;
      ui.note.value = state.extras.note || "";

      ui.sprinkleLabel.textContent = `${state.sprinkleAmt}%`;
      ui.stickerLabel.textContent = `${state.stickerSize}%`;
    }

    // ---------- SVG building blocks ----------
    function shapeClip(shape){ return `clip_${shape}`; }

    function buildCookieBase(shape){
      if(shape === "heart"){
        return `
          <path d="M180 310
                   C140 290 85 252 85 195
                   C85 152 115 130 145 130
                   C165 130 176 140 180 150
                   C184 140 195 130 215 130
                   C245 130 275 152 275 195
                   C275 252 220 290 180 310Z"
                fill="url(#cookieGrad)" stroke="rgba(11,27,42,.10)" stroke-width="2"/>
          ${chocoChipsMask("heart")}
        `;
      }
      if(shape === "star"){
        return `
          <path d="M180 60
                   L210 128
                   L284 136
                   L228 184
                   L246 258
                   L180 220
                   L114 258
                   L132 184
                   L76 136
                   L150 128Z"
                fill="url(#cookieGrad)" stroke="rgba(11,27,42,.10)" stroke-width="2"/>
          ${chocoChipsMask("star")}
        `;
      }
      return `
        <circle cx="180" cy="180" r="128" fill="url(#cookieGrad)" stroke="rgba(11,27,42,.10)" stroke-width="2"/>
        ${chocoChipsMask("round")}
      `;
    }

    function chocoChipsMask(shape){
      const chips = [
        [130,130,9],[210,120,7],[250,175,8],[165,220,7],[110,205,6],[220,235,9],[185,175,6]
      ];
      const clip = shapeClip(shape);
      return `
        <g clip-path="url(#${clip})" opacity=".55">
          ${chips.map(([x,y,r])=>`<circle cx="${x}" cy="${y}" r="${r}" fill="rgba(90,54,30,.55)"/>`).join("")}
        </g>
      `;
    }

    function buildIcing(shape, icing, drip){
      const defs = `
        <defs>
          <clipPath id="clip_round"><circle cx="180" cy="180" r="128"/></clipPath>
          <clipPath id="clip_heart">
            <path d="M180 310 C140 290 85 252 85 195 C85 152 115 130 145 130
                     C165 130 176 140 180 150 C184 140 195 130 215 130
                     C245 130 275 152 275 195 C275 252 220 290 180 310Z"/>
          </clipPath>
          <clipPath id="clip_star">
            <path d="M180 60 L210 128 L284 136 L228 184 L246 258 L180 220
                     L114 258 L132 184 L76 136 L150 128Z"/>
          </clipPath>

          <linearGradient id="icingPink" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="rgba(255,79,163,.85)"/>
            <stop offset="100%" stop-color="rgba(255,124,197,.65)"/>
          </linearGradient>
          <linearGradient id="icingVanilla" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="rgba(255,248,235,.92)"/>
            <stop offset="100%" stop-color="rgba(255,229,200,.72)"/>
          </linearGradient>
          <linearGradient id="icingChoco" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="rgba(92,50,24,.86)"/>
            <stop offset="100%" stop-color="rgba(140,78,44,.66)"/>
          </linearGradient>
          <linearGradient id="icingMint" x1="0" x2="0" y1="0" y2="1">
            <stop offset="0%" stop-color="rgba(190,255,238,.85)"/>
            <stop offset="100%" stop-color="rgba(120,240,210,.62)"/>
          </linearGradient>
        </defs>
      `;

      if(icing === "none") return defs;

      const fill = ({
        pink: "url(#icingPink)",
        vanilla: "url(#icingVanilla)",
        choco: "url(#icingChoco)",
        mint: "url(#icingMint)"
      }[icing]) || "url(#icingPink)";

      const clip = shapeClip(shape);
      const top = icingTopPath(shape);
      const dripPath = drip === "drip" ? icingDripPath(shape) : (drip === "zigzag" ? icingZigzagPath(shape) : "");

      return `
        ${defs}
        <g clip-path="url(#${clip})">
          <path d="${top}" fill="${fill}" filter="url(#gloss)"></path>
          ${dripPath ? `<path d="${dripPath}" fill="${fill}" opacity=".92" filter="url(#gloss)"></path>` : ""}
          <path d="${top}" fill="none" stroke="rgba(255,255,255,.35)" stroke-width="2" opacity=".55"></path>
        </g>
      `;
    }

    function icingTopPath(shape){
      if(shape==="heart"){
        return "M105 170 C120 130 160 110 180 122 C200 110 240 130 255 170 C250 188 240 205 220 214 C200 224 160 224 140 214 C120 205 110 188 105 170Z";
      }
      if(shape==="star"){
        return "M120 140 C150 100 210 100 240 140 C235 170 210 190 180 192 C150 190 125 170 120 140Z";
      }
      return "M95 150 C120 105 240 105 265 150 C255 195 225 220 180 222 C135 220 105 195 95 150Z";
    }
    function icingDripPath(shape){
      if(shape==="heart"){
        return "M112 178 C125 205 120 230 134 246 C148 262 150 240 160 232 C170 224 176 255 186 252 C196 249 198 225 208 228 C218 231 220 260 235 246 C250 232 245 205 252 178 Z";
      }
      if(shape==="star"){
        return "M128 160 C138 188 135 210 150 222 C165 234 165 210 175 205 C185 200 190 230 202 226 C214 222 214 196 224 202 C234 208 236 234 250 222 C264 210 258 188 246 160 Z";
      }
      return "M102 165 C118 196 112 225 130 240 C148 255 150 230 162 224 C174 218 178 252 190 248 C202 244 202 212 214 218 C226 224 228 255 248 240 C268 225 260 196 258 165 Z";
    }
    function icingZigzagPath(shape){
      if(shape==="heart"){
        return "M110 178 L130 195 L150 178 L170 195 L190 178 L210 195 L230 178 L250 195 L255 178 L110 178Z";
      }
      if(shape==="star"){
        return "M130 162 L148 176 L166 162 L184 176 L202 162 L220 176 L238 162 L246 170 L130 170Z";
      }
      return "M105 165 L125 182 L145 165 L165 182 L185 165 L205 182 L225 165 L245 182 L258 165 L105 165Z";
    }

    function sprinkleColor(i){
      const colors = [
        "rgba(255,79,163,.95)",
        "rgba(255,196,0,.90)",
        "rgba(120,240,210,.90)",
        "rgba(255,255,255,.85)",
        "rgba(92,50,24,.65)"
      ];
      return colors[i % colors.length];
    }

    function starPath(cx, cy, r){
      const pts = [];
      for(let i=0;i<10;i++){
        const ang = (Math.PI/5)*i - Math.PI/2;
        const rr = (i%2===0)? r : r*0.45;
        pts.push([cx + Math.cos(ang)*rr, cy + Math.sin(ang)*rr]);
      }
      return "M" + pts.map(p=>p.map(n=>n.toFixed(1)).join(" ")).join(" L ") + " Z";
    }

    function buildSprinkles(shape, type, amt){
      if(type === "none" || amt <= 0) return "";
      const clip = shapeClip(shape);
      const n = Math.round(amt * (type==="confetti" ? 2.2 : 1.6));
      const items = [];
      const bounds = {x0:95, y0:120, x1:265, y1:250};

      for(let i=0;i<n;i++){
        const x = rand(bounds.x0, bounds.x1);
        const y = rand(bounds.y0, bounds.y1);
        const rot = rand(0,359);

        if(type === "dots"){
          items.push(`<circle cx="${x}" cy="${y}" r="${rand(2,4)}" fill="${sprinkleColor(i)}" opacity=".95"/>`);
        } else if(type === "stars"){
          items.push(`<path d="${starPath(x,y,rand(3,5))}" fill="${sprinkleColor(i)}" opacity=".95" transform="rotate(${rot} ${x} ${y})"/>`);
        } else {
          const w = rand(5,10), h = rand(2,4);
          items.push(`<rect x="${x}" y="${y}" width="${w}" height="${h}" rx="2" fill="${sprinkleColor(i)}" opacity=".95" transform="rotate(${rot} ${x} ${y})"/>`);
        }
      }

      return `<g clip-path="url(#${clip})" opacity=".9">${items.join("")}</g>`;
    }

    function buildSticker(shape, sticker, sizePct){
      if(sticker === "none") return "";
      const clip = shapeClip(shape);
      const s = sizePct/100;
      const x = 180, y = 118;
      return `<g clip-path="url(#${clip})" transform="translate(${x} ${y}) scale(${s})">${stickerSvg(sticker)}</g>`;
    }

    function stickerSvg(kind){
      if(kind === "bow"){
        return `
          <g filter="url(#gloss)">
            <path d="M-62 10 C-88 -10 -88 -36 -62 -46 C-40 -54 -22 -36 -18 -18 C-14 -2 -32 22 -62 10Z" fill="rgba(255,79,163,.85)"/>
            <path d="M62 10 C88 -10 88 -36 62 -46 C40 -54 22 -36 18 -18 C14 -2 32 22 62 10Z" fill="rgba(255,124,197,.75)"/>
            <circle cx="0" cy="-10" r="14" fill="rgba(255,255,255,.75)" stroke="rgba(11,27,42,.10)"/>
            <path d="M-10 0 C-6 18 -20 30 -32 34 C-14 32 -2 20 0 6 C2 20 14 32 32 34 C20 30 6 18 10 0Z" fill="rgba(255,255,255,.55)" opacity=".85"/>
          </g>
        `;
      }
      if(kind === "heart"){
        return `
          <g filter="url(#gloss)">
            <path d="M0 48 C-34 26 -54 6 -54 -20 C-54 -40 -40 -54 -22 -54
                     C-8 -54 -2 -46 0 -40 C2 -46 8 -54 22 -54
                     C40 -54 54 -40 54 -20 C54 6 34 26 0 48Z"
                  fill="rgba(255,79,163,.85)" stroke="rgba(255,255,255,.45)" stroke-width="3"/>
          </g>
        `;
      }
      if(kind === "sparkle"){
        return `
          <g filter="url(#gloss)">
            <path d="M0 -60 L12 -18 L50 0 L12 18 L0 60 L-12 18 L-50 0 L-12 -18Z"
                  fill="rgba(255,255,255,.85)" stroke="rgba(255,79,163,.35)" stroke-width="3"/>
            <circle cx="38" cy="-34" r="10" fill="rgba(255,196,0,.88)"/>
          </g>
        `;
      }
      return `
        <g filter="url(#gloss)">
          <circle cx="0" cy="0" r="44" fill="rgba(255,248,235,.88)" stroke="rgba(11,27,42,.10)" stroke-width="3"/>
          <circle cx="-16" cy="-10" r="6" fill="rgba(11,27,42,.65)"/>
          <circle cx="16" cy="-10" r="6" fill="rgba(11,27,42,.65)"/>
          <path d="M-18 12 C-8 26 8 26 18 12" fill="none" stroke="rgba(11,27,42,.55)" stroke-width="5" stroke-linecap="round"/>
        </g>
      `;
    }

    function wrapText(str, maxChars){
      const words = str.split(/\s+/).filter(Boolean);
      const lines = [];
      let line = "";
      for(const w of words){
        const test = line ? line + " " + w : w;
        if(test.length <= maxChars) line = test;
        else{ if(line) lines.push(line); line = w; }
      }
      if(line) lines.push(line);
      if(lines.length===0 && str.length){
        for(let i=0;i<str.length;i+=maxChars) lines.push(str.slice(i,i+maxChars));
      }
      return lines.length ? lines : [str];
    }

    function buildText(shape, msg){
      const text = (msg || "").trim().slice(0, 140);
      if(!text) return "";
      const clip = shapeClip(shape);
      const lines = wrapText(text, 18).slice(0, 3);
      const y0 = 210 - (lines.length-1)*16;
      const font = 18;

      return `
        <g clip-path="url(#${clip})">
          <text x="180" y="${y0}" text-anchor="middle"
                font-size="${font}" font-weight="950"
                fill="rgba(11,27,42,.72)"
                style="letter-spacing:.2px">
            ${lines.map((ln,i)=>`<tspan x="180" dy="${i===0?0:22}">${escapeXml(ln)}</tspan>`).join("")}
          </text>
          <text x="180" y="${y0+2}" text-anchor="middle"
                font-size="${font}" font-weight="950"
                fill="rgba(255,255,255,.35)"
                style="letter-spacing:.2px" opacity=".55">
            ${lines.map((ln,i)=>`<tspan x="180" dy="${i===0?0:22}">${escapeXml(ln)}</tspan>`).join("")}
          </text>
        </g>
      `;
    }

    // ---------- SVG -> PNG for Share ----------
    async function svgToPngBlob(svgEl, width, height){
      const svgClone = svgEl.cloneNode(true);
      svgClone.setAttribute("width", width);
      svgClone.setAttribute("height", height);
      svgClone.setAttribute("viewBox", "0 0 360 360");

      const xml = new XMLSerializer().serializeToString(svgClone);
      const svgBlob = new Blob([xml], { type: "image/svg+xml;charset=utf-8" });
      const url = URL.createObjectURL(svgBlob);

      const img = new Image();
      img.decoding = "async";
      await new Promise((res, rej)=>{ img.onload = res; img.onerror = rej; img.src = url; });

      const canvas = document.createElement("canvas");
      canvas.width = width; canvas.height = height;
      const ctx = canvas.getContext("2d");
      ctx.fillStyle = "rgba(255,255,255,1)";
      ctx.fillRect(0,0,width,height);
      ctx.drawImage(img, 0, 0, width, height);

      URL.revokeObjectURL(url);
      return await new Promise((res)=> canvas.toBlob(res, "image/png", 0.92));
    }

    // ---------- Init ----------
    function init(){
      // show draft loaded
      if(localStorage.getItem(LS_KEY)) toast("Draft geladen üç™");

      // ensure panels visible
      syncInputsFromState();
      render(structuredClone(state));

      // If draft had step 3 but extras fields missing, keep safe
      state.step = Math.max(1, Math.min(3, state.step || 1));
      goStep(state.step); // also triggers render + save
    }

    init();
  </script>
</body>
</html>
