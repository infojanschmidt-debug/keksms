<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OnlyKeks ‚Äì Post, die schmeckt</title>
  <meta name="description" content="Schick eine Nachricht als Keks. QR scan ‚Üí echte Antwort zur√ºck. Schnell, pers√∂nlich, viral." />
  <meta name="theme-color" content="#0E0E11" />
  <style>
    :root{
      --bg:#0E0E11;
      --panel: rgba(21,21,28,.66);
      --stroke: rgba(255,255,255,.10);
      --text:#F2F2F4;
      --muted:#B9BBC6;
      --gold:#E6C27A;
      --pink:#ff4fa3;
      --shadow: 0 24px 60px rgba(0,0,0,.55);
      --shadowSoft: 0 12px 30px rgba(0,0,0,.35);
      --r:18px;

      --common:#b9b9b9;
      --uncommon:#2ecc71;
      --rare:#4aa3ff;
      --epic:#b56bff;
      --legendary:#f6d26a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background: radial-gradient(1200px 700px at 50% 20%, #1a1a24 0%, var(--bg) 55%, #09090c 100%);
      overflow:hidden;
    }
    a{color:inherit}

    /* Intro */
    .intro{
      position:fixed; inset:0; z-index:9999;
      display:grid; place-items:center;
      background: radial-gradient(1200px 700px at 50% 20%, #1a1a24 0%, var(--bg) 55%, #09090c 100%);
    }
    .intro video{
      width:min(980px, 92vw);
      height:auto;
      border-radius:24px;
      border:1px solid rgba(255,255,255,.10);
      box-shadow: var(--shadow);
      background:#000;
    }
    .introBar{
      position:absolute; left:18px; right:18px; bottom:16px;
      display:flex; gap:10px; justify-content:space-between; align-items:center; flex-wrap:wrap;
      color:rgba(185,187,198,.9);
      font-size:12px;
    }

    /* Stage */
    .stage{position:relative; width:100%; height:100vh;}
    canvas#keks3d{width:100%; height:100vh; display:block; outline:none; background:transparent;}

    .uiOverlay{position:absolute; inset:0; pointer-events:none;}
    .topBar{
      pointer-events:auto;
      position:absolute; left:18px; right:18px; top:16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .brand{
      display:flex; align-items:center; gap:10px;
      padding:10px 14px;
      border:1px solid var(--stroke);
      border-radius:999px;
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.02));
      box-shadow: var(--shadowSoft);
      backdrop-filter: blur(12px);
    }
    .logo{
      width:34px;height:34px;border-radius:12px;
      display:grid;place-items:center;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.14) 0 35%, rgba(230,194,122,.18) 36% 100%);
      border:1px solid rgba(255,255,255,.10);
    }
    .brand strong{font-weight:950; letter-spacing:.2px}
    .pill{
      font-size:12px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.22);
      color: var(--muted);
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(230,194,122,.35);
      background: rgba(230,194,122,.08);
      color: var(--gold);
      font-weight:900;
      font-size:12px;
      white-space:nowrap;
    }
    .dot{width:10px;height:10px;border-radius:99px;background:var(--common);}

    .btn{
      pointer-events:auto;
      appearance:none; border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.06);
      color: var(--text);
      height:44px;
      padding:0 14px;
      border-radius:14px;
      font-weight:900;
      letter-spacing:.2px;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .18s cubic-bezier(.2,.9,.2,1), box-shadow .18s cubic-bezier(.2,.9,.2,1), background .18s;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.08)}
    .btn:active{transform: translateY(1px) scale(.99); box-shadow:none}
    .btnPrimary{
      background: linear-gradient(180deg, rgba(230,194,122,.98), rgba(184,137,91,.98));
      border-color: rgba(230,194,122,.45);
      color: #14141A;
    }
    .btnGhost{background: rgba(0,0,0,.22)}
    .btnDanger{background: rgba(255,79,163,.14); border-color: rgba(255,79,163,.24)}

    .panel{
      pointer-events:auto;
      position:absolute;
      right:18px;
      top:78px;
      width: min(420px, calc(100% - 36px));
      border:1px solid rgba(255,255,255,.10);
      background: var(--panel);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(14px);
      padding:16px;
    }
    .h1{margin:0 0 8px; font-size: clamp(28px, 3.2vw, 44px); line-height:1.05; font-weight:980}
    .sub{margin:0 0 12px; color: var(--muted); line-height:1.45; font-size: 14.5px}
    .hr{height:1px; background: rgba(255,255,255,.10); margin:12px 0}
    .label{font-size:12px; color: rgba(185,187,198,.9); font-weight:900; margin:10px 0 6px}
    .input{
      width:100%;
      height:46px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding:0 14px;
      font-size:16px;
      font-weight:850;
      outline:none;
    }
    .chip{
      pointer-events:auto;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      color: var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      transition: transform .16s cubic-bezier(.2,.9,.2,1), background .16s;
    }
    .chip:hover{transform: translateY(-1px); background: rgba(255,255,255,.06)}
    .chip.on{border-color: rgba(230,194,122,.40); background: rgba(230,194,122,.10); color: var(--gold)}
    .hint{margin:10px 0 0; color: rgba(185,187,198,.85); font-size:12.5px; line-height:1.45}

    .bottomBar{
      pointer-events:auto;
      position:absolute;
      left:18px; right:18px; bottom:16px;
      display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;
    }
    .trust{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center;
      color: rgba(185,187,198,.9);
      font-size:12px;
    }
    .trust span{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
      border-radius:999px;
      padding:8px 10px;
    }

    .consent{
      position:fixed; left:12px; right:12px; bottom:12px; z-index:9998;
      max-width:980px; margin:0 auto;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(21,21,28,.86);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:12px;
      display:none;
      backdrop-filter: blur(14px);
    }
    .consentRow{display:flex; gap:10px; align-items:center; justify-content:space-between; flex-wrap:wrap}
    .consent p{margin:0; color: rgba(185,187,198,.95); font-size:13px; line-height:1.35}
    .consent strong{color:var(--text)}

    body.godmode .panel{display:none}
    body.godmode .trust{display:none}
    body.godmode .btnGod{background: rgba(230,194,122,.14); border-color: rgba(230,194,122,.30)}
  </style>
</head>

<body>

  <!-- Intro Video (assets/Intro.mp4) -->
  <div class="intro" id="intro">
    <video id="introVid" playsinline muted preload="auto">
      <source src="assets/Intro.mp4" type="video/mp4">
    </video>
    <div class="introBar">
      <span>Wenn Autoplay blockt: Klick ins Video.</span>
      <button class="btn btnGhost" id="skipIntro" type="button">Skip</button>
    </div>
  </div>

  <section class="stage" aria-label="3D Keks Konfigurator">
    <canvas id="keks3d" tabindex="0"></canvas>

    <div class="uiOverlay">
      <div class="topBar">
        <div class="row">
          <div class="brand">
            <div class="logo">üç™</div>
            <strong>OnlyKeks</strong>
            <span class="pill">Post, die schmeckt</span>
          </div>

          <div class="badge">
            <span class="dot" id="rarityDot"></span>
            <span id="rarityText">COMMON</span>
          </div>
        </div>

        <div class="row">
          <button class="btn btnGhost" id="btnHall" type="button">Hall of Keks</button>
          <button class="btn btnGhost btnGod" id="btnGod" type="button">Godmode</button>
          <button class="btn btnPrimary" id="btnSurprise" type="button">√úberrasch mich</button>
        </div>
      </div>

      <aside class="panel" id="panel">
        <h1 class="h1">Schick ‚Äône Message. Als Keks.</h1>
        <p class="sub">Echter 3D-Keks. Minimal UI. Maximal Wirkung. Empf√§nger scannt ‚Äì antwortet direkt.</p>

        <div class="label">Message</div>
        <input class="input" id="msgInput" maxlength="32" value="Ich denk an dich." aria-label="Message" />

        <div class="hr"></div>

        <div class="label">Set w√§hlen</div>
        <div class="row" id="setRow"></div>

        <div class="label">Form</div>
        <div class="row" id="shapeRow">
          <button class="chip on" data-shape="circle" type="button">Kreis</button>
          <button class="chip" data-shape="heart" type="button">Herz</button>
          <button class="chip" data-shape="star" type="button">Stern</button>
        </div>

        <div class="label">Deko</div>
        <div class="row" id="decoRow">
          <button class="chip on" data-deco="sprinkles" type="button">Sprinkles</button>
          <button class="chip" data-deco="gold" type="button">Gold</button>
        </div>

        <div class="hr"></div>

        <div class="row">
          <button class="btn btnPrimary" id="checkoutBtn" type="button" style="flex:1">Keks losschicken</button>
          <button class="btn btnGhost" id="shareBtn" type="button" style="display:none; flex:1">Keks teilen</button>
        </div>

        <p class="hint" id="hint">Common‚ÄìRare: bisschen Style. Epic‚ÄìLegendary: weniger basteln, mehr Wirkung.</p>
      </aside>

      <div class="bottomBar">
        <div class="trust">
          <span>‚úì Kein Abo</span>
          <span>‚úì Keine Datenverk√§ufe</span>
          <span><a href="./privacy.html">Wie wir mit Daten umgehen</a></span>
        </div>
        <div class="row">
          <button class="btn btnDanger" id="btnExitGod" type="button" style="display:none">Exit Godmode</button>
        </div>
      </div>
    </div>
  </section>

  <!-- Consent -->
  <div class="consent" id="consent">
    <div class="consentRow">
      <p>
        <strong>Kurzer Cookie-Keks:</strong> Wir speichern den Entwurf lokal, damit nix verloren geht. Optional hilft anonymes Feedback.
        <span style="display:block;margin-top:6px"><a href="./privacy.html">Wie wir mit Daten umgehen</a></span>
      </p>
      <div class="row" style="margin:0">
        <button class="btn btnPrimary" id="consentAll">Alles klar</button>
        <button class="btn btnGhost" id="consentNeed">Nur das N√∂tigste</button>
      </div>
    </div>
  </div>

<script type="module">
  import * as THREE from "https://unpkg.com/three@0.160.0/build/three.module.js";
  import { OrbitControls } from "https://unpkg.com/three@0.160.0/examples/jsm/controls/OrbitControls.js";

  /* =========================
     CONFIG / STORAGE
  ========================= */
  const LEGENDARY_ACTIVE = true;

  const RARITY = {
    common:    { label:"COMMON",    css:"--common",    glow:0.18, ring:false, spr:0.55 },
    uncommon:  { label:"UNCOMMON",  css:"--uncommon",  glow:0.24, ring:false, spr:0.75 },
    rare:      { label:"RARE",      css:"--rare",      glow:0.30, ring:false, spr:0.95 },
    epic:      { label:"EPIC",      css:"--epic",      glow:0.42, ring:true,  spr:0.35 },
    legendary: { label:"LEGENDARY", css:"--legendary", glow:0.55, ring:true,  spr:0.15 },
  };

  const SETS = [
    { id:"thinkofyou", name:"Ich denk an dich",  rarity:"common",    shape:"circle", message:"Ich denk an dich." },
    { id:"yougotthis", name:"Du packst das",     rarity:"uncommon",  shape:"star",   message:"Du packst das."   },
    { id:"move",       name:"Beweg dein Arsch.", rarity:"rare",      shape:"circle", message:"Beweg dein Arsch." },
    { id:"sorry",      name:"Sorry.",            rarity:"epic",      shape:"heart",  message:"Sorry."          },
    { id:"comeNow",    name:"Komm. Jetzt.",      rarity:"legendary", shape:"heart",  message:"Komm. Jetzt."    },
  ];

  const STORAGE_KEY_DRAFT = "ok_draft_v4";
  const STORAGE_KEY_SHARE = "ok_share_map_v1";   // shareCode -> snapshot
  const STORAGE_KEY_HALL  = "ok_hall_v1";        // array feed

  const state = {
    setId:"thinkofyou",
    rarity:"common",
    shape:"circle",
    message:"Ich denk an dich.",
    decoSprinkles:true,
    decoGold:false,
    orderId:null,
    shareCode:null,
    seed:"DEMO"
  };

  const $ = (id)=>document.getElementById(id);

  function getCssVar(name){
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
  }

  function saveDraft(){ localStorage.setItem(STORAGE_KEY_DRAFT, JSON.stringify(state)); }
  function loadDraft(){
    try{ const raw = localStorage.getItem(STORAGE_KEY_DRAFT); if(!raw) return;
      Object.assign(state, JSON.parse(raw));
    }catch{}
  }

  function loadJSON(key, fallback){
    try{ const v = localStorage.getItem(key); return v ? JSON.parse(v) : fallback; }catch{ return fallback; }
  }
  function saveJSON(key, obj){ localStorage.setItem(key, JSON.stringify(obj)); }

  /* =========================
     CONSENT
  ========================= */
  (function consent(){
    const key="ok_consent_v2";
    const c = $("consent");
    const v = localStorage.getItem(key);
    if(!v){ c.style.display="block"; }
    $("consentAll").onclick=()=>{ localStorage.setItem(key,"all"); c.style.display="none"; };
    $("consentNeed").onclick=()=>{ localStorage.setItem(key,"need"); c.style.display="none"; };
  })();

  /* =========================
     INTRO VIDEO (Autoplay + Fallback)
  ========================= */
  const intro = $("intro");
  const introVid = $("introVid");
  const skipIntro = $("skipIntro");

  function endIntro(){
    intro.style.display="none";
    introVid.pause();
  }
  skipIntro.onclick = endIntro;

  (async function(){
    try{
      introVid.muted = true;
      introVid.playsInline = true;
      await introVid.play();
      introVid.onended = endIntro;
      intro.onclick = endIntro; // click anywhere = skip
      // fallback timeout: wenn Video h√§ngt
      setTimeout(()=>{ if(intro.style.display!=="none") endIntro(); }, 6500);
    }catch{
      // Autoplay block -> user click
      introVid.controls = true;
      intro.onclick = ()=> introVid.play().then(()=>{ introVid.onended=endIntro; }).catch(()=>{});
    }
  })();

  /* =========================
     UI
  ========================= */
  function setRarityUI(){
    const r = RARITY[state.rarity] || RARITY.common;
    $("rarityText").textContent = r.label;
    $("rarityDot").style.background = getCssVar(r.css) || "#bbb";
    $("hint").textContent = (state.rarity==="epic"||state.rarity==="legendary")
      ? "Epic/Legendary: Fokus auf Wirkung. Weniger Deko-Ged√∂ns."
      : "Common‚ÄìRare: bisschen Style. Kurz. Direkt.";
  }

  function renderSetRow(){
    const row = $("setRow");
    row.innerHTML = "";
    SETS.forEach(s=>{
      const disabled = (s.rarity==="legendary" && !LEGENDARY_ACTIVE);
      const b = document.createElement("button");
      b.className = "chip" + (state.setId===s.id ? " on" : "");
      b.type = "button";
      b.textContent = s.name;
      if(disabled){ b.style.opacity=".45"; b.style.cursor="not-allowed"; }
      b.onclick = ()=>{ if(!disabled) applySet(s.id); };
      row.appendChild(b);
    });
  }

  function setChipsActive(containerId, key, value){
    document.querySelectorAll(`#${containerId} .chip`).forEach(b=>{
      b.classList.toggle("on", b.dataset[key] === value);
    });
  }

  function toggleDecoChip(){
    document.querySelectorAll("#decoRow .chip").forEach(b=>{
      const k = b.dataset.deco;
      const on = (k==="sprinkles" ? state.decoSprinkles : state.decoGold);
      b.classList.toggle("on", !!on);
    });
  }

  function applySet(id){
    const s = SETS.find(x=>x.id===id) || SETS[0];
    state.setId = s.id;
    state.rarity = s.rarity;
    state.shape = s.shape;
    state.message = s.message;

    if(state.rarity==="legendary" && !LEGENDARY_ACTIVE){
      Object.assign(state, { setId:"sorry", rarity:"epic", shape:"heart", message:"Sorry." });
    }
    $("msgInput").value = state.message;

    // Seed stabilisieren pro Set + Text (damit Optik ‚Äúlebt‚Äù aber nicht jittert)
    state.seed = (state.shareCode || "DRAFT") + "_" + state.setId + "_" + state.message;

    renderSetRow();
    setChipsActive("shapeRow","shape",state.shape);
    setRarityUI();
    update3DFromState();
    saveDraft();
  }

  /* =========================
     Deterministic RNG (Seeded)
  ========================= */
  function xfnv1a(str){
    let h=2166136261;
    for(let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
    return h>>>0;
  }
  function mulberry32(a){
    return function(){
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ (t >>> 15), t | 1);
      t ^= t + Math.imul(t ^ (t >>> 7), t | 61);
      return ((t ^ (t >>> 14)) >>> 0) / 4294967296;
    };
  }

  /* =========================
     THREE: Scene
  ========================= */
  const canvas = $("keks3d");
  const renderer = new THREE.WebGLRenderer({ canvas, antialias:true, alpha:true });
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 1.6));
  renderer.setSize(window.innerWidth, window.innerHeight);
  renderer.outputColorSpace = THREE.SRGBColorSpace;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.05;
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;

  const scene = new THREE.Scene();
  scene.fog = new THREE.Fog(0x0e0e11, 8, 22);

  const camera = new THREE.PerspectiveCamera(40, window.innerWidth/window.innerHeight, 0.1, 80);
  camera.position.set(0.0, 1.55, 6.2);

  const controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;
  controls.dampingFactor = 0.06;
  controls.minDistance = 3.0;
  controls.maxDistance = 9.0;
  controls.maxPolarAngle = Math.PI * 0.48;
  controls.target.set(0, 1.15, 0);

  scene.add(new THREE.HemisphereLight(0xffffff, 0x101014, 0.55));

  const key = new THREE.DirectionalLight(0xffffff, 1.25);
  key.position.set(2.6, 6.0, 3.8);
  key.castShadow = true;
  key.shadow.mapSize.set(2048, 2048);
  key.shadow.camera.near = 0.5; key.shadow.camera.far = 30;
  key.shadow.camera.left = -6; key.shadow.camera.right = 6;
  key.shadow.camera.top = 6; key.shadow.camera.bottom = -6;
  scene.add(key);

  const rim = new THREE.DirectionalLight(0xE6C27A, 0.55);
  rim.position.set(-4.5, 2.2, -3.5);
  scene.add(rim);

  const fill = new THREE.PointLight(0xB8895B, 0.22, 18);
  fill.position.set(0.0, 2.2, 2.4);
  scene.add(fill);

  const floor = new THREE.Mesh(
    new THREE.PlaneGeometry(24, 24),
    new THREE.ShadowMaterial({ opacity: 0.28 })
  );
  floor.rotation.x = -Math.PI/2;
  floor.position.y = 0;
  floor.receiveShadow = true;
  scene.add(floor);

  const cookieGroup = new THREE.Group();
  scene.add(cookieGroup);

  const cookieMat = new THREE.MeshStandardMaterial({ color: 0xC9935A, roughness: 0.95, metalness: 0.0 });
  const goldMat   = new THREE.MeshStandardMaterial({ color: 0xE6C27A, roughness: 0.25, metalness: 0.75 });
  const sprinkleMat = new THREE.MeshStandardMaterial({ color: 0xff4fa3, roughness: 0.35, metalness: 0.1 });
  const sprinkleGoldMat = new THREE.MeshStandardMaterial({ color: 0xE6C27A, roughness: 0.25, metalness: 0.75 });

  let cookieMesh = new THREE.Mesh(new THREE.CylinderGeometry(1.35, 1.45, 0.35, 48, 1, false), cookieMat);
  cookieMesh.castShadow = true;
  cookieMesh.position.set(0, 1.05, 0);
  cookieGroup.add(cookieMesh);

  const glaze = new THREE.Mesh(new THREE.TorusGeometry(1.05, 0.08, 16, 64), goldMat);
  glaze.castShadow = true;
  glaze.position.set(0, 1.18, 0);
  glaze.rotation.x = Math.PI/2;
  cookieGroup.add(glaze);

  const sprinkleGeo = new THREE.CapsuleGeometry(0.08, 0.10, 4, 8);
  const sprinkleCount = 48;
  const sprinkles = new THREE.InstancedMesh(sprinkleGeo, sprinkleMat, sprinkleCount);
  sprinkles.castShadow = true;
  cookieGroup.add(sprinkles);

  // Text texture
  const textCanvas = document.createElement("canvas");
  textCanvas.width = 1024; textCanvas.height = 512;
  const tctx = textCanvas.getContext("2d");
  const textTex = new THREE.CanvasTexture(textCanvas);
  textTex.colorSpace = THREE.SRGBColorSpace;
  const textMat = new THREE.MeshBasicMaterial({ map: textTex, transparent: true });
  const textPlane = new THREE.Mesh(new THREE.PlaneGeometry(2.1, 1.05), textMat);
  textPlane.position.set(0, 1.32, 0.06);
  textPlane.rotation.x = -0.22;
  cookieGroup.add(textPlane);

  function roundRect(ctx, x, y, w, h, r){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
  }
  function wrapLines(text, maxChars){
    const words = String(text||"").trim().split(/\s+/);
    if(!words[0]) return [];
    const lines=[]; let cur="";
    for(const w of words){
      const next = cur ? (cur+" "+w) : w;
      if(next.length<=maxChars) cur=next;
      else{ if(cur) lines.push(cur); cur=w; }
    }
    if(cur) lines.push(cur);
    return lines;
  }
  function drawText(msg, rarity){
    const r = RARITY[rarity] || RARITY.common;
    tctx.clearRect(0,0,textCanvas.width,textCanvas.height);

    tctx.fillStyle = "rgba(255,255,255,0.10)";
    roundRect(tctx, 80, 120, 864, 270, 48);
    tctx.fill();

    tctx.textAlign="center"; tctx.textBaseline="middle";
    tctx.fillStyle = (rarity==="legendary"||rarity==="epic") ? "rgba(230,194,122,0.95)" : "rgba(240,240,244,0.92)";
    tctx.font = "900 74px system-ui, -apple-system, Segoe UI, Roboto, Arial";

    const lines = wrapLines(msg, 18).slice(0,3);
    const startY = 255 - (lines.length-1)*64;
    lines.forEach((ln,i)=> tctx.fillText(ln, 512, startY + i*80));

    tctx.fillStyle = "rgba(185,187,198,0.70)";
    tctx.font = "800 26px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    tctx.fillText(r.label, 512, 420);

    textTex.needsUpdate = true;
  }

  let lastShape = null;
  function rebuildShape(shape){
    if(shape === lastShape) return;
    lastShape = shape;

    const old = cookieMesh.geometry;
    let geom;

    if(shape==="heart"){
      const s = new THREE.Shape();
      s.moveTo(0, 0.55);
      s.bezierCurveTo(0.8, 1.25, 1.65, 0.55, 0, -1.0);
      s.bezierCurveTo(-1.65, 0.55, -0.8, 1.25, 0, 0.55);
      geom = new THREE.ExtrudeGeometry(s, { depth:0.35, bevelEnabled:true, bevelSize:0.08, bevelThickness:0.06, bevelSegments:4, steps:1 });
      geom.center();
    } else if(shape==="star"){
      const star = new THREE.Shape();
      const spikes=5, outerR=1.45, innerR=0.70;
      for(let i=0;i<spikes*2;i++){
        const a=(i/(spikes*2))*Math.PI*2 - Math.PI/2;
        const rr=(i%2===0)?outerR:innerR;
        const x=Math.cos(a)*rr, y=Math.sin(a)*rr;
        if(i===0) star.moveTo(x,y); else star.lineTo(x,y);
      }
      star.closePath();
      geom = new THREE.ExtrudeGeometry(star, { depth:0.35, bevelEnabled:true, bevelSize:0.08, bevelThickness:0.06, bevelSegments:4, steps:1 });
      geom.center();
    } else {
      geom = new THREE.CylinderGeometry(1.35, 1.45, 0.35, 48, 1, false);
    }

    cookieMesh.geometry = geom;
    old.dispose();
  }

  function placeSprinklesDeterministic(enabled){
    if(!enabled){ sprinkles.visible=false; return; }
    sprinkles.visible=true;

    const seed = xfnv1a(state.seed || "DRAFT");
    const rnd = mulberry32(seed);

    for(let i=0;i<sprinkleCount;i++){
      const a = rnd()*Math.PI*2;
      const r = 0.18 + rnd()*1.05;
      const x = Math.cos(a)*r;
      const z = Math.sin(a)*r;
      const y = 1.25 + rnd()*0.05;
      const rotY = rnd()*Math.PI;
      const rotZ = rnd()*Math.PI;

      const m = new THREE.Matrix4();
      const q = new THREE.Quaternion().setFromEuler(new THREE.Euler(0, rotY, rotZ));
      m.compose(new THREE.Vector3(x,y,z), q, new THREE.Vector3(1,1,1));
      sprinkles.setMatrixAt(i, m);
    }
    sprinkles.instanceMatrix.needsUpdate = true;
  }

  // ‚ÄúGlow‚Äù via light intensities (cheap but wirkt). MVP.
  function applyRarityLook(){
    const r = RARITY[state.rarity] || RARITY.common;
    const glowColor = new THREE.Color(getCssVar(r.css) || "#bbb");

    // Cookie tint
    const base = new THREE.Color(0xC9935A).lerp(glowColor, 0.10);
    cookieMat.color.copy(base);

    // Ring visibility
    glaze.visible = !!(state.decoGold || r.ring);
    // Sprinkles material switch only (no re-create)
    sprinkles.material = state.decoGold ? sprinkleGoldMat : sprinkleMat;

    // Lights: ‚Äúpremium spotlight‚Äù
    rim.color = (state.rarity==="legendary" || state.rarity==="epic") ? new THREE.Color(0xE6C27A) : glowColor;
    rim.intensity = 0.45 + r.glow;

    fill.intensity = 0.18 + r.glow*0.35;
    renderer.toneMappingExposure = document.body.classList.contains("godmode") ? 1.12 : (1.04 + r.glow*0.06);
  }

  function update3DFromState(){
    const r = RARITY[state.rarity] || RARITY.common;

    rebuildShape(state.shape);
    drawText(state.message, state.rarity);

    const sprEnabled = state.decoSprinkles && (r.spr > 0.2);
    placeSprinklesDeterministic(sprEnabled);

    applyRarityLook();

    setRarityUI();
    renderSetRow();
    toggleDecoChip();
    saveDraft();
  }

  /* =========================
     GODMODE
  ========================= */
  function setGodmode(on){
    document.body.classList.toggle("godmode", !!on);
    $("btnExitGod").style.display = on ? "inline-flex" : "none";

    if(on){
      controls.minDistance=2.3; controls.maxDistance=6.5; controls.maxPolarAngle=Math.PI*0.58;
    } else {
      controls.minDistance=3.0; controls.maxDistance=9.0; controls.maxPolarAngle=Math.PI*0.48;
    }
    update3DFromState();
  }

  /* =========================
     SHARE / CHECKOUT / HALL (MVP local)
  ========================= */
  function hashMini(str){
    let h=2166136261;
    for(let i=0;i<str.length;i++){ h ^= str.charCodeAt(i); h = Math.imul(h, 16777619); }
    return (h>>>0).toString(36).slice(0,8).toUpperCase();
  }

  function persistShareSnapshot(){
    const map = loadJSON(STORAGE_KEY_SHARE, {});
    map[state.shareCode] = {
      at: Date.now(),
      state: { ...state }
    };
    saveJSON(STORAGE_KEY_SHARE, map);
  }

  function pushHallItem(){
    const hall = loadJSON(STORAGE_KEY_HALL, []);
    hall.unshift({
      id: state.shareCode,
      rarity: state.rarity,
      message: state.message,
      shape: state.shape,
      ts: Date.now()
    });
    hall.splice(60);
    saveJSON(STORAGE_KEY_HALL, hall);
  }

  function doCheckout(){
    const now = Date.now().toString(36).toUpperCase();
    state.orderId = "OK_" + now;
    state.shareCode = hashMini(state.orderId + "_" + state.rarity + "_" + state.setId + "_" + state.message);
    state.seed = state.shareCode; // ab Checkout: Seed = shareCode (stabil!)

    persistShareSnapshot();
    pushHallItem();
    saveDraft();

    $("shareBtn").style.display = "inline-flex";
    $("hint").textContent = "MVP: Share & Hall laufen lokal. N√§chster Step: Stripe + Server-Persist.";

    alert(
`‚úÖ Keks bereit.
Share: keks.html?share=${state.shareCode}
Reply: keks.html?reply=${state.orderId}&from=${state.shareCode}`
    );
  }

  function doShare(){
    const base = location.href.replace(/index\.html.*$/,"");
    const link = base + "keks.html?share=" + (state.shareCode || "");
    navigator.clipboard?.writeText(link).catch(()=>{});
    alert("Link kopiert:\n" + link);
  }

  /* =========================
     EVENTS
  ========================= */
  $("msgInput").addEventListener("input", ()=>{
    state.message = $("msgInput").value.trim() || "‚Ä¶";
    state.seed = (state.shareCode || "DRAFT") + "_" + state.setId + "_" + state.message;
    update3DFromState();
  });

  document.querySelectorAll("#shapeRow .chip").forEach(b=>{
    b.onclick=()=>{
      state.shape=b.dataset.shape;
      setChipsActive("shapeRow","shape",state.shape);
      update3DFromState();
    };
  });

  document.querySelectorAll("#decoRow .chip").forEach(b=>{
    b.onclick=()=>{
      const k=b.dataset.deco;
      if(k==="sprinkles") state.decoSprinkles=!state.decoSprinkles;
      if(k==="gold") state.decoGold=!state.decoGold;
      toggleDecoChip();
      update3DFromState();
    };
  });

  $("btnSurprise").onclick=()=>{
    const pool = SETS.filter(s=> s.rarity!=="legendary" || LEGENDARY_ACTIVE);
    const pick = pool[Math.floor(Math.random()*pool.length)];
    applySet(pick.id);

    const variants = {
      thinkofyou:["Ich denk an dich.","Vermiss dich.","Nur kurz: Du fehlst."],
      yougotthis:["Du packst das.","Heute wird dein Tag.","Kopf hoch. Weiter."],
      move:["Beweg dein Arsch.","Heute. Keine Ausreden.","Aufstehen. Machen."],
      sorry:["Sorry.","Ich mein‚Äôs ernst.","Tut mir leid."],
      comeNow:["Komm. Jetzt.","Sag‚Äôs. Und komm.","Heute Nacht. Du & ick."]
    };
    const v=variants[pick.id];
    if(v){
      state.message = v[Math.floor(Math.random()*v.length)];
      $("msgInput").value = state.message;
      state.seed = (state.shareCode || "DRAFT") + "_" + state.setId + "_" + state.message;
      update3DFromState();
    }
  };

  $("btnGod").onclick=()=> setGodmode(!document.body.classList.contains("godmode"));
  $("btnExitGod").onclick=()=> setGodmode(false);

  $("btnHall").onclick=()=>{ location.href="./keks.html"; };

  $("checkoutBtn").onclick=doCheckout;
  $("shareBtn").onclick=doShare;

  /* =========================
     INIT
  ========================= */
  (function init(){
    loadDraft();
    if(state.rarity==="legendary" && !LEGENDARY_ACTIVE){
      Object.assign(state, { setId:"sorry", rarity:"epic", shape:"heart", message:"Sorry." });
    }
    $("msgInput").value = state.message || "Ich denk an dich.";
    renderSetRow();
    setChipsActive("shapeRow","shape",state.shape);
    toggleDecoChip();
    setRarityUI();
    state.seed = state.shareCode || ("DRAFT_" + state.setId + "_" + state.message);
    update3DFromState();
  })();

  /* =========================
     LOOP
  ========================= */
  let t0 = performance.now();
  function tick(){
    requestAnimationFrame(tick);
    const t = (performance.now()-t0)*0.001;
    cookieGroup.rotation.y = Math.sin(t*0.35)*0.12;
    cookieGroup.position.y = Math.sin(t*0.8)*0.03;
    controls.update();
    renderer.render(scene, camera);
  }
  tick();

  window.addEventListener("resize", ()=>{
    renderer.setSize(window.innerWidth, window.innerHeight);
    camera.aspect = window.innerWidth/window.innerHeight;
    camera.updateProjectionMatrix();
  });
</script>
</body>
</html>
