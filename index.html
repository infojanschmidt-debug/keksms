<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OnlyKeks – Post, die schmeckt</title>
  <meta name="description" content="Gestalte deinen Keks. Verschicken. QR-Rücksendung bekommen. Wir backen den Rücksend-Keks und schicken ihn dir." />
  <meta name="theme-color" content="#ff4fa3" />
  <link rel="canonical" href="https://infojanschmidt-debug.github.io/keksms/" />
  <meta name="robots" content="index,follow" />

  <style>
    :root{
      --bg:#ffffff;
      --ink:#0b1b2a;
      --muted:#516173;
      --line: rgba(11,27,42,.10);
      --pink:#ff4fa3;
      --pink2:#ff7cc5;
      --soft: rgba(255,79,163,.12);
      --soft2: rgba(255,124,197,.10);
      --shadow: 0 16px 50px rgba(11,27,42,.10);
      --r: 18px;
      --r2: 26px;

      --max: 1040px;
      --h1: clamp(28px, 5vw, 52px);
      --h2: clamp(20px, 3.4vw, 30px);
      --fz: 16px;
      --focus: 0 0 0 4px rgba(255,79,163,.22);
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font: 800 var(--fz)/1.55 system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(900px 520px at 10% 0%, var(--soft) 0 60%, transparent 61%),
        radial-gradient(700px 460px at 95% 10%, var(--soft2) 0 60%, transparent 61%),
        #fff;
      overflow-x: clip;
    }
    a{ color:inherit; text-decoration:none; }
    .wrap{ max-width: var(--max); margin:0 auto; padding: 16px 16px 60px; }

    /* Header */
    header{
      position: sticky; top:0; z-index:50;
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(11,27,42,.06);
    }
    .head{
      display:flex; align-items:center; justify-content:space-between; gap:12px;
      padding: 10px 16px;
      max-width: var(--max); margin:0 auto;
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width: 180px; }
    .logo{
      width: 42px; height: 42px; border-radius: 16px;
      background: radial-gradient(circle at 30% 25%, #fff 0 18%, #ffe7f3 19% 46%, #ff9ed0 47% 70%, #ff4fa3 71% 100%);
      box-shadow: 0 10px 22px rgba(11,27,42,.10);
      position:relative; overflow:hidden;
      flex:0 0 auto;
    }
    .logo:before{
      content:""; position:absolute; inset:10px; border-radius:999px;
      background: radial-gradient(circle at 35% 35%, #fff6e8 0 38%, #f6c07c 39% 100%);
      opacity:.92;
    }
    .brandTitle{ line-height:1.05; font-weight:1000; }
    .brandSub{ font-size:12px; color: var(--muted); font-weight:900; }

    nav{ display:flex; align-items:center; gap:14px; }
    nav a{ font-weight:1000; padding: 10px 10px; border-radius: 12px; color: rgba(11,27,42,.86); }
    nav a:hover{ background: rgba(11,27,42,.05); }

    .btn{
      appearance:none; border:0; cursor:pointer;
      padding: 12px 14px; border-radius: 14px;
      font-weight:1000;
      background: rgba(11,27,42,.06);
      color: rgba(11,27,42,.88);
    }
    .btnPrimary{
      background: linear-gradient(135deg, var(--pink), var(--pink2));
      color:#fff;
      box-shadow: 0 12px 28px rgba(11,27,42,.12);
    }

    /* Hero */
    .hero{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 18px;
      align-items: stretch;
      padding: 22px 0 8px;
    }
    .card{
      background:#fff;
      border: 1px solid var(--line);
      border-radius: var(--r2);
      box-shadow: var(--shadow);
      padding: 16px;
    }
    h1{ margin:0 0 10px; font-size: var(--h1); line-height:1.04; letter-spacing:-.6px; }
    .sub{ margin:0 0 12px; color: var(--muted); font-weight:850; max-width: 60ch; }
    .chips{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 12px; }
    .chip{
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(11,27,42,.10);
      background: rgba(255,255,255,.85);
      font-weight:1000;
      color: rgba(11,27,42,.80);
    }
    .ctaRow{ display:flex; gap:10px; flex-wrap:wrap; margin-top: 14px; }

    .trust{
      display:grid; grid-template-columns: repeat(2, minmax(0,1fr));
      gap: 10px;
    }
    .trustItem{
      border: 1px solid rgba(11,27,42,.08);
      background: rgba(11,27,42,.03);
      border-radius: var(--r);
      padding: 12px;
      font-weight: 950;
    }
    .trustItem small{ display:block; margin-top:4px; color: var(--muted); font-weight:850; }

    /* Sections */
    section{ padding: 14px 0; }
    h2{ margin: 0 0 10px; font-size: var(--h2); letter-spacing:-.3px; }
    .grid2{ display:grid; grid-template-columns: 1fr 1fr; gap: 14px; }
    .muted{ color: var(--muted); font-weight:850; }

    /* Configurator */
    .cfg{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      align-items:start;
    }
    label{ display:block; margin-top: 12px; font-weight:1000; }
    input, textarea, select{
      width:100%;
      margin-top:8px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(11,27,42,.14);
      font: inherit;
      background:#fff;
      color: var(--ink);
      font-weight:900;
    }
    textarea{ min-height: 96px; resize: vertical; }
    input:focus, textarea:focus, select:focus{ outline:none; box-shadow: var(--focus); border-color: rgba(255,79,163,.55); }

    .packRow{ display:grid; gap:10px; margin-top: 6px; }
    .packTile{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 12px;
      border-radius: var(--r);
      border: 1px solid rgba(11,27,42,.10);
      background:#fff;
      cursor:pointer;
      font-weight:1000;
    }
    .packTile.active{
      border-color: rgba(255,79,163,.45);
      box-shadow: 0 12px 30px rgba(255,79,163,.12);
      background: rgba(255,79,163,.06);
    }
    .badge{
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(11,27,42,.10);
      background: rgba(255,255,255,.85);
      font-weight:1000;
    }
    .badgeHot{ border-color: rgba(255,79,163,.35); background: rgba(255,79,163,.08); }

    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .miniCard{
      border: 1px solid rgba(11,27,42,.10);
      border-radius: var(--r);
      background: #fff;
      padding: 12px;
    }

    /* Preview */
    .previewWrap{
      border: 1px solid rgba(11,27,42,.10);
      background: rgba(255,255,255,.75);
      border-radius: var(--r2);
      padding: 12px;
      overflow: visible; /* wichtig: nichts abschneiden */
    }
    .previewStage{
      border-radius: var(--r2);
      border: 1px dashed rgba(11,27,42,.14);
      background: rgba(255,79,163,.05);
      min-height: 240px;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 16px;
      overflow: visible;
    }
    .cookie{
      width: min(240px, 70vw);
      height: auto;
      display:block;
      overflow: visible;
      filter: drop-shadow(0 18px 26px rgba(11,27,42,.10));
    }
    .msgOverlay{
      position:absolute;
      inset: 28%;
      display:flex;
      align-items:center;
      justify-content:center;
      text-align:center;
      padding: 10px;
      font-size: clamp(12px, 3.6vw, 16px);
      line-height: 1.2;
      font-weight: 1000;
      color: rgba(11,27,42,.86);
      border-radius: 16px;
      background: rgba(255,255,255,.75);
      border: 1px solid rgba(11,27,42,.10);
      backdrop-filter: blur(8px);
    }

    .stickyPay{
      position: sticky;
      bottom: 10px;
      z-index: 5;
      margin-top: 14px;
    }

    /* Item list */
    .items{ display:grid; gap: 12px; margin-top: 12px; }
    .itemHead{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }

    /* FAQ */
    details{
      border: 1px solid rgba(11,27,42,.10);
      border-radius: var(--r2);
      background:#fff;
      padding: 12px 14px;
    }
    summary{ cursor:pointer; font-weight:1000; }
    details p{ margin: 10px 0 0; color: var(--muted); font-weight:850; }

    /* Footer */
    footer{ padding: 24px 0 40px; color: rgba(11,27,42,.70); }
    .footRow{ display:flex; gap:10px; flex-wrap:wrap; }

    /* Intro overlay */
    #intro{
      position: fixed;
      inset: 0;
      z-index: 9999;
      background:
        radial-gradient(900px 520px at 10% 0%, rgba(255,79,163,.18) 0 60%, transparent 61%),
        radial-gradient(700px 460px at 95% 10%, rgba(255,124,197,.14) 0 60%, transparent 61%),
        #fff;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }
    #intro.hidden{ display:none; }
    #introBox{
      width: min(92vw, 520px);
      border-radius: 24px;
      overflow:hidden;
      box-shadow: 0 22px 70px rgba(11,27,42,.20);
      border: 1px solid rgba(11,27,42,.10);
      background:#fff;
      position: relative;
    }
    #introVideo{
      width:100%;
      height:auto;
      display:block;
      background:#fff;
    }
    #skipIntro{
      position:absolute;
      top: 10px;
      right: 10px;
      padding: 10px 12px;
      border-radius: 999px;
      border: 1px solid rgba(11,27,42,.14);
      background: rgba(255,255,255,.88);
      font-weight: 1000;
      cursor:pointer;
    }

    /* Mobile */
    @media (max-width: 900px){
      nav{ display:none; }
      .hero{ grid-template-columns: 1fr; }
      .cfg{ grid-template-columns: 1fr; }
      .trust{ grid-template-columns: 1fr 1fr; }
      .previewStage{ min-height: 220px; }
    }
    @media (max-width: 520px){
      .trust{ grid-template-columns: 1fr; }
    }
  </style>
</head>

<body id="top">

  <!-- Intro -->
  <div id="intro" aria-label="Intro">
    <div id="introBox">
      <button id="skipIntro" type="button" aria-label="Intro überspringen">Skip</button>

      <!-- WICHTIG: Exakter Pfad aus deinem Repo -->
      <video id="introVideo" muted playsinline preload="auto" autoplay>
        <source src="assets/video/grok_video_2025-12-14-00-41-51.mp4" type="video/mp4">
      </video>
    </div>
  </div>

  <header>
    <div class="head">
      <a class="brand" href="#top" aria-label="OnlyKeks Start">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <div class="brandTitle">OnlyKeks</div>
          <div class="brandSub">Post, die schmeckt</div>
        </div>
      </a>

      <nav aria-label="Navigation">
        <a href="#so-gehts">So geht’s</a>
        <a href="#konfigurator">Konfigurator</a>
        <a href="#faq">FAQ</a>
      </nav>

      <button class="btn btnPrimary" type="button" onclick="document.getElementById('konfigurator').scrollIntoView({behavior:'smooth'})">
        Jetzt starten →
      </button>
    </div>
  </header>

  <main class="wrap">
    <section class="hero">
      <div class="card">
        <h1>Schick ’nen Keks. Hol dir ’nen Rücksend-Keks.</h1>
        <p class="sub">
          Du schickst eine süße Botschaft mit QR-Code. Die Empfängerin scannt, schreibt den Rücksend-Text –
          und wir backen den Rücksend-Keks und schicken ihn dir.
        </p>

        <div class="chips" aria-label="Ablauf">
          <span class="chip">1 Keks wählen</span>
          <span class="chip">2 Botschaft drauf</span>
          <span class="chip">3 QR scannen</span>
          <span class="chip">4 Rücksend-Keks kommt</span>
        </div>

        <div class="ctaRow">
          <button class="btn btnPrimary" type="button" onclick="document.getElementById('konfigurator').scrollIntoView({behavior:'smooth'})">Keks gestalten →</button>
          <button class="btn" type="button" onclick="document.getElementById('so-gehts').scrollIntoView({behavior:'smooth'})">So funktioniert’s</button>
        </div>
      </div>

      <div class="card">
        <div class="trust">
          <div class="trustItem">Versand mit Tracking<small>Du siehst, wo der Keks ist.</small></div>
          <div class="trustItem">Sicher bezahlen<small>Zahlungslink (Stripe) möglich.</small></div>
          <div class="trustItem">Ohne Account<small>Scannen → tippen → absenden.</small></div>
          <div class="trustItem">Allergene klar<small>Transparente Infos.</small></div>
        </div>
      </div>
    </section>

    <section id="so-gehts">
      <div class="grid2">
        <div class="card">
          <h2>So geht’s</h2>
          <p class="muted">
            Du gestaltest deinen Keks und verschickst ihn. Auf dem Keks ist ein QR-Code.
            Die Empfängerin scannt ihn, schreibt den Rücksend-Text – wir backen daraus den Rücksend-Keks und schicken ihn zurück.
          </p>
        </div>

        <div class="card">
          <h2>Wichtig</h2>
          <p class="muted">
            MVP-Logik: Links und Entwürfe werden lokal gespeichert. Später kommt die echte Verarbeitung serverseitig dazu.
          </p>
        </div>
      </div>
    </section>

    <section id="konfigurator">
      <div class="card">
        <h2>Konfigurator</h2>
        <p class="muted">Wähle Paket, Anzahl und gestalte pro Keks Empfänger + Botschaft. Der QR pro Keks ist sofort sichtbar.</p>

        <div class="cfg" style="margin-top:12px;">
          <!-- Left: inputs -->
          <div>
            <label>Paket</label>
            <select id="pack" aria-label="Paket wählen">
              <option value="Quick">Quick</option>
              <option value="Custom" selected>Custom</option>
              <option value="Premium">Premium</option>
            </select>

            <div class="packRow" id="packTiles" aria-label="Pakete">
              <div class="packTile" data-pack="Quick">
                <div>
                  <div style="font-weight:1100;">Quick</div>
                  <div class="muted" style="font-size:13px;">Schnell & sweet. Für kurze Messages.</div>
                </div>
                <span class="badge">simple & sweet</span>
              </div>

              <div class="packTile active" data-pack="Custom">
                <div>
                  <div style="font-weight:1100;">Custom</div>
                  <div class="muted" style="font-size:13px;">Deko-Optionen + nicer Look. Bestseller.</div>
                </div>
                <span class="badge badgeHot">3er-Deal: −15%</span>
              </div>

              <div class="packTile" data-pack="Premium">
                <div>
                  <div style="font-weight:1100;">Premium</div>
                  <div class="muted" style="font-size:13px;">Box-Feeling + maximaler Wow-Effekt.</div>
                </div>
                <span class="badge">Box-Vibe</span>
              </div>
            </div>

            <label>Wie viele Kekse willst du verschicken?</label>
            <input id="qty" type="number" min="1" max="10" value="1" inputmode="numeric" />

            <div class="miniCard" style="margin-top:12px;">
              <div style="font-weight:1100;">Deal-Hinweis</div>
              <div class="muted" style="font-size:13px;">Ab 3 Keksen ist der 3er-Deal aktiv.</div>
            </div>

            <label>Dein Name</label>
            <input id="senderName" placeholder="z. B. Schmidti" autocomplete="name" />

            <label>Deine Adresse (Rücksendung)</label>
            <input id="senderAddr" placeholder="Straße & Hausnummer, PLZ Ort" autocomplete="street-address" />

            <div class="stickyPay">
              <div class="miniCard">
                <div class="row" style="justify-content:space-between;">
                  <div>
                    <div style="font-weight:1100;">Gesamt</div>
                    <div class="muted" style="font-size:13px;" id="priceNote">inkl. 3er-Deal falls aktiv</div>
                  </div>
                  <div style="font-weight:1200; font-size:20px;" id="total">—</div>
                </div>

                <div class="row" style="margin-top:10px;">
                  <button class="btn btnPrimary" type="button" id="saveDraft">Entwurf speichern</button>
                  <button class="btn" type="button" id="toPay">Weiter zum Bezahlen</button>
                </div>

                <div class="muted" style="font-size:12.5px; margin-top:10px;">
                  Hinweis: Zahlung ist im MVP aktuell Demo. Stripe-Link kannst du später direkt verdrahten.
                </div>
              </div>
            </div>
          </div>

          <!-- Right: preview + items -->
          <div>
            <div class="previewWrap">
              <div class="row" style="justify-content:space-between;">
                <span class="badge">Live-Vorschau</span>
                <button class="btn" type="button" id="randomize">Zufall</button>
              </div>

              <div class="previewStage" style="margin-top:10px; position:relative;">
                <svg id="cookieSvg" class="cookie" viewBox="0 0 200 200" aria-label="Keks Vorschau" role="img">
                  <defs>
                    <radialGradient id="g1" cx="35%" cy="35%">
                      <stop offset="0%" stop-color="#fff2dc"/>
                      <stop offset="45%" stop-color="#f6c07c"/>
                      <stop offset="100%" stop-color="#e3a25a"/>
                    </radialGradient>
                  </defs>
                  <circle cx="100" cy="100" r="78" fill="url(#g1)"/>
                  <circle cx="70" cy="70" r="5" fill="#c98945" opacity=".55"/>
                  <circle cx="130" cy="80" r="6" fill="#c98945" opacity=".55"/>
                  <circle cx="115" cy="125" r="4" fill="#c98945" opacity=".55"/>
                  <circle cx="80" cy="125" r="5" fill="#c98945" opacity=".55"/>
                </svg>

                <div class="msgOverlay" id="previewText">Deine Botschaft</div>
              </div>

              <div class="muted" style="font-size:12.5px; margin-top:10px;">
                Tipp: Kurz schreiben. Knallt mehr. Und passt besser auf ’nen Keks.
              </div>

              <div class="row" style="margin-top:12px;">
                <span class="badge">Keksform</span>
                <button class="btn" type="button" data-shape="circle">Kreis</button>
                <button class="btn" type="button" data-shape="heart">Herz</button>
                <button class="btn" type="button" data-shape="star">Stern</button>
                <button class="btn" type="button" data-shape="smiley">Smiley</button>
                <button class="btn" type="button" data-shape="tree">Tannenbaum</button>
              </div>

              <label>Botschaft (für Vorschau)</label>
              <input id="previewInput" maxlength="80" placeholder="z. B. Ich bin stolz auf dich." />
            </div>

            <div class="items" id="items"></div>
          </div>
        </div>
      </div>
    </section>

    <section id="faq">
      <h2>FAQ</h2>

      <div class="grid2">
        <details class="card">
          <summary>Muss die Empfängerin etwas installieren?</summary>
          <p>Nein. QR scannen, Rücksend-Text tippen, absenden. Fertig.</p>
        </details>

        <details class="card">
          <summary>Wie funktioniert der Rücksend-Keks genau?</summary>
          <p>Der QR führt zu einer Rücksend-Seite. Der Rücksend-Text wird als neue Botschaft gebacken und an dich verschickt.</p>
        </details>

        <details class="card">
          <summary>Mehrere Empfänger – wie funktioniert das?</summary>
          <p>Du wählst die Anzahl. Jeder Keks hat eigene Botschaft und eigene Adresse. Jeder Keks bekommt seinen eigenen QR-Rücksend-Link.</p>
        </details>

        <details class="card">
          <summary>Welche Daten speichert ihr?</summary>
          <p>Notwendig: Entwurf lokal im Browser. Optional: später Auswertung, welche Kekse gefallen. Wir verkaufen keine Daten.</p>
        </details>
      </div>
    </section>

    <footer>
      <div class="card">
        <div style="display:flex; align-items:center; gap:10px;">
          <div class="logo" aria-hidden="true" style="width:34px;height:34px;border-radius:14px;"></div>
          <div>
            <div style="font-weight:1100;">OnlyKeks</div>
            <div class="muted" style="font-size:12.5px;">MVP: One-Page-Landing + Konfigurator. Geschenk-Mood, Vertrauen, QR-Rücksendung.</div>
          </div>
        </div>

        <div class="footRow" style="margin-top:12px;">
          <a class="btn" href="privacy.html">Wie wir mit Daten umgehen</a>
          <a class="btn" href="#faq">FAQ</a>
          <a class="btn" href="#top">Nach oben</a>
        </div>
      </div>
    </footer>

  </main>

  <!-- QR library -->
  <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>

  <script>
    /* ---------- Intro: absolut stabil (kein schwarzer Screen) ---------- */
    (function(){
      const intro = document.getElementById("intro");
      const v = document.getElementById("introVideo");
      const skip = document.getElementById("skipIntro");

      function hideIntro(){
        if(!intro || intro.classList.contains("hidden")) return;
        intro.classList.add("hidden");
        try{ v.pause(); }catch(_){}
      }

      if(skip) skip.addEventListener("click", hideIntro);

      // Failsafe: raus nach 4.5s, egal was passiert
      const failsafe = setTimeout(hideIntro, 4500);

      (async () => {
        try{
          v.muted = true;
          v.playsInline = true;

          const p = v.play();
          if(p && typeof p.then === "function") await p;

          v.addEventListener("playing", () => clearTimeout(failsafe), { once:true });
          v.addEventListener("ended", hideIntro, { once:true });
          v.addEventListener("error", hideIntro, { once:true });
          v.addEventListener("stalled", hideIntro, { once:true });
        }catch(e){
          hideIntro();
        }
      })();
    })();

    /* ---------- App State ---------- */
    const LS = {
      draft: "ok_draft_v2",
      draftId: "ok_draft_id_v1"
    };

    function makeToken(len=18){
      const a = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      let s = "";
      for(let i=0;i<len;i++) s += a[Math.floor(Math.random()*a.length)];
      return s;
    }

    function getDraftId(){
      let id = localStorage.getItem(LS.draftId);
      if(!id){
        id = "DRAFT-" + Date.now().toString(36).toUpperCase();
        localStorage.setItem(LS.draftId, id);
      }
      return id;
    }

    function basePath(){
      const u = new URL(location.href);
      u.hash = "";
      u.search = "";
      u.pathname = u.pathname.replace(/index\.html$/,"");
      return u.toString();
    }

    function euro(n){
      return new Intl.NumberFormat("de-DE", { style:"currency", currency:"EUR" }).format(n);
    }

    const PRICES = {
      Quick: 9.90,
      Custom: 14.90,
      Premium: 24.90
    };
    const DEAL_QTY = 3;
    const DEAL_OFF = 0.15;

    let state = {
      pack: "Custom",
      qty: 1,
      senderName: "",
      senderAddr: "",
      previewText: "",
      shape: "circle",
      items: []
    };

    function ensureItems(){
      const n = Math.max(1, Math.min(10, parseInt(state.qty,10) || 1));
      state.qty = n;

      while(state.items.length < n){
        state.items.push({
          name: "",
          addr: "",
          msg: "",
          _token: makeToken(18)
        });
      }
      while(state.items.length > n) state.items.pop();
    }

    function calcTotal(){
      const base = PRICES[state.pack] * state.qty;
      const disc = (state.qty >= DEAL_QTY) ? base * DEAL_OFF : 0;
      return { base, disc, total: base - disc };
    }

    function replyUrlFor(idx){
      const base = basePath();
      const oid = encodeURIComponent(getDraftId());
      const k = idx + 1;
      const t = encodeURIComponent(state.items[idx]._token);
      return `${base}keks.html?oid=${oid}&k=${k}&t=${t}`;
    }

    function saveDraft(){
      const payload = {
        ...state,
        draftId: getDraftId(),
        savedAt: new Date().toISOString()
      };
      localStorage.setItem(LS.draft, JSON.stringify(payload));
      toast("Entwurf gespeichert.");
    }

    function loadDraft(){
      const raw = localStorage.getItem(LS.draft);
      if(!raw) return;
      try{
        const d = JSON.parse(raw);
        if(!d) return;
        state.pack = d.pack || state.pack;
        state.qty = d.qty || state.qty;
        state.senderName = d.senderName || "";
        state.senderAddr = d.senderAddr || "";
        state.previewText = d.previewText || "";
        state.shape = d.shape || "circle";
        state.items = Array.isArray(d.items) ? d.items : [];
      }catch(_){}
    }

    /* ---------- UI refs ---------- */
    const packSel = document.getElementById("pack");
    const packTiles = document.getElementById("packTiles");
    const qtyInp = document.getElementById("qty");
    const senderName = document.getElementById("senderName");
    const senderAddr = document.getElementById("senderAddr");
    const itemsEl = document.getElementById("items");
    const totalEl = document.getElementById("total");
    const previewInput = document.getElementById("previewInput");
    const previewText = document.getElementById("previewText");
    const cookieSvg = document.getElementById("cookieSvg");
    const randomizeBtn = document.getElementById("randomize");
    const saveBtn = document.getElementById("saveDraft");
    const payBtn = document.getElementById("toPay");

    /* ---------- Toast ---------- */
    function toast(msg){
      let t = document.getElementById("toast");
      if(!t){
        t = document.createElement("div");
        t.id = "toast";
        t.style.position = "fixed";
        t.style.left = "50%";
        t.style.bottom = "18px";
        t.style.transform = "translateX(-50%)";
        t.style.background = "#111a24";
        t.style.color = "#fff";
        t.style.padding = "10px 12px";
        t.style.borderRadius = "999px";
        t.style.fontWeight = "1000";
        t.style.opacity = "0";
        t.style.pointerEvents = "none";
        t.style.transition = "opacity .18s ease, transform .18s ease";
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.opacity = "1";
      t.style.transform = "translateX(-50%) translateY(-6px)";
      setTimeout(() => {
        t.style.opacity = "0";
        t.style.transform = "translateX(-50%)";
      }, 2200);
    }

    /* ---------- Render ---------- */
    function setShape(shape){
      state.shape = shape;

      // sehr leichte „Form-Simulation“ über SVG-Anpassung
      const svg = cookieSvg;
      svg.innerHTML = `
        <defs>
          <radialGradient id="g1" cx="35%" cy="35%">
            <stop offset="0%" stop-color="#fff2dc"/>
            <stop offset="45%" stop-color="#f6c07c"/>
            <stop offset="100%" stop-color="#e3a25a"/>
          </radialGradient>
        </defs>
      `;

      if(shape === "circle"){
        svg.setAttribute("viewBox","0 0 200 200");
        svg.insertAdjacentHTML("beforeend", `<circle cx="100" cy="100" r="78" fill="url(#g1)"/>`);
      }else if(shape === "heart"){
        svg.setAttribute("viewBox","0 0 200 200");
        svg.insertAdjacentHTML("beforeend", `<path d="M100 160c-40-26-70-52-70-86 0-18 12-32 30-32 16 0 28 10 40 22 12-12 24-22 40-22 18 0 30 14 30 32 0 34-30 60-70 86z" fill="url(#g1)"/>`);
      }else if(shape === "star"){
        svg.setAttribute("viewBox","0 0 200 200");
        svg.insertAdjacentHTML("beforeend", `<path d="M100 22l20 56h58l-47 34 18 56-49-35-49 35 18-56-47-34h58z" fill="url(#g1)"/>`);
      }else if(shape === "smiley"){
        svg.setAttribute("viewBox","0 0 200 200");
        svg.insertAdjacentHTML("beforeend", `
          <circle cx="100" cy="100" r="78" fill="url(#g1)"/>
          <circle cx="76" cy="90" r="7" fill="#7a4c23" opacity=".55"/>
          <circle cx="124" cy="90" r="7" fill="#7a4c23" opacity=".55"/>
          <path d="M70 118c10 20 50 20 60 0" fill="none" stroke="#7a4c23" stroke-width="8" stroke-linecap="round" opacity=".55"/>
        `);
      }else if(shape === "tree"){
        svg.setAttribute("viewBox","0 0 200 200");
        svg.insertAdjacentHTML("beforeend", `
          <path d="M100 22l36 40h-18l30 34h-18l28 34H42l28-34H52l30-34H64z" fill="url(#g1)"/>
          <rect x="90" y="140" width="20" height="26" rx="6" fill="#c98945" opacity=".7"/>
        `);
      }

      // „Chocolate chips“ (random look)
      const chips = [
        [70,70,5],[130,80,6],[115,125,4],[80,125,5]
      ];
      chips.forEach(([x,y,r]) => {
        svg.insertAdjacentHTML("beforeend", `<circle cx="${x}" cy="${y}" r="${r}" fill="#c98945" opacity=".55"/>`);
      });

      // Stern-Clipping-Fix: Textoverlay etwas kleiner
      if(shape === "star"){
        previewText.style.inset = "32%";
      }else{
        previewText.style.inset = "28%";
      }
    }

    function renderTotals(){
      const c = calcTotal();
      totalEl.textContent = euro(c.total);
    }

    function renderItems(){
      ensureItems();
      itemsEl.innerHTML = "";

      state.items.forEach((it, idx) => {
        const card = document.createElement("div");
        card.className = "card";
        card.innerHTML = `
          <div class="itemHead">
            <span class="badge">Keks ${idx+1}</span>
            ${state.qty > 1 ? `<button class="btn" type="button" data-remove="${idx}">Entfernen</button>` : ``}
          </div>

          <label>Empfängername</label>
          <input data-kname="${idx}" placeholder="z. B. Kayti" value="${escapeHtml(it.name)}" />

          <label>Empfängeradresse</label>
          <input data-kaddr="${idx}" placeholder="Straße & Hausnummer, PLZ Ort" value="${escapeHtml(it.addr)}" />

          <label>Botschaft (Keks ${idx+1})</label>
          <textarea data-kmsg="${idx}" maxlength="500" placeholder="Kurze Botschaft…">${escapeHtml(it.msg)}</textarea>

          <div style="display:grid; gap:10px; margin-top:12px;">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:10px;">
              <b>QR-Rücksendung</b>
              <button class="btn" type="button" data-copyqr="${idx}">Link kopieren</button>
            </div>

            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
              <canvas id="qr_${idx}" width="128" height="128"
                style="border-radius:14px; border:1px solid rgba(11,27,42,.10); background:#fff;"></canvas>
              <div class="muted" style="word-break:break-all; font-weight:850;">
                <span id="qrurl_${idx}"></span>
              </div>
            </div>
          </div>
        `;
        itemsEl.appendChild(card);
      });

      // QR rendern
      state.items.forEach((_, idx) => {
        const url = replyUrlFor(idx);
        const urlEl = document.getElementById(`qrurl_${idx}`);
        if(urlEl) urlEl.textContent = url;

        const c = document.getElementById(`qr_${idx}`);
        if(c && window.QRious){
          new QRious({ element: c, value: url, size: 128, level: "H" });
        }
      });
    }

    function escapeHtml(s){
      return String(s ?? "").replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    function syncInputs(){
      packSel.value = state.pack;
      qtyInp.value = state.qty;
      senderName.value = state.senderName;
      senderAddr.value = state.senderAddr;
      previewInput.value = state.previewText;
      previewText.textContent = (state.previewText || "Deine Botschaft").slice(0,80);
      setShape(state.shape);
      renderTotals();
      renderItems();
      syncPackTiles();
    }

    function syncPackTiles(){
      [...packTiles.querySelectorAll(".packTile")].forEach(t => {
        t.classList.toggle("active", t.dataset.pack === state.pack);
      });
    }

    /* ---------- Events ---------- */
    packSel.addEventListener("change", () => {
      state.pack = packSel.value;
      renderTotals();
      syncPackTiles();
    });

    packTiles.addEventListener("click", (e) => {
      const t = e.target.closest(".packTile");
      if(!t) return;
      state.pack = t.dataset.pack;
      packSel.value = state.pack;
      renderTotals();
      syncPackTiles();
    });

    qtyInp.addEventListener("input", () => {
      state.qty = parseInt(qtyInp.value,10) || 1;
      renderTotals();
      renderItems();
    });

    senderName.addEventListener("input", () => state.senderName = senderName.value);
    senderAddr.addEventListener("input", () => state.senderAddr = senderAddr.value);

    previewInput.addEventListener("input", () => {
      state.previewText = previewInput.value;
      previewText.textContent = (state.previewText || "Deine Botschaft").slice(0,80);
    });

    document.querySelectorAll("[data-shape]").forEach(b => {
      b.addEventListener("click", () => setShape(b.dataset.shape));
    });

    randomizeBtn.addEventListener("click", () => {
      const samples = [
        "Ich denk an dich.",
        "Du packst das.",
        "Vermisse dich.",
        "Danke für alles.",
        "Ich bin stolz auf dich."
      ];
      state.previewText = samples[Math.floor(Math.random()*samples.length)];
      previewInput.value = state.previewText;
      previewText.textContent = state.previewText;
      toast("Vorschau zufällig gesetzt.");
    });

    itemsEl.addEventListener("input", (e) => {
      const el = e.target;
      if(el.dataset.kname != null){
        const i = parseInt(el.dataset.kname,10);
        state.items[i].name = el.value;
      }
      if(el.dataset.kaddr != null){
        const i = parseInt(el.dataset.kaddr,10);
        state.items[i].addr = el.value;
      }
      if(el.dataset.kmsg != null){
        const i = parseInt(el.dataset.kmsg,10);
        state.items[i].msg = el.value;
      }
    });

    itemsEl.addEventListener("click", async (e) => {
      const copy = e.target.closest("button[data-copyqr]");
      if(copy){
        const idx = parseInt(copy.dataset.copyqr,10);
        const url = replyUrlFor(idx);
        try{
          await navigator.clipboard.writeText(url);
          toast("QR-Link kopiert.");
        }catch(_){
          toast("Kopieren ging nicht – bitte manuell markieren.");
        }
        return;
      }
      const rem = e.target.closest("button[data-remove]");
      if(rem){
        const idx = parseInt(rem.dataset.remove,10);
        state.items.splice(idx,1);
        state.qty = Math.max(1, state.items.length);
        qtyInp.value = state.qty;
        renderTotals();
        renderItems();
        toast("Keks entfernt.");
      }
    });

    saveBtn.addEventListener("click", () => saveDraft());

    payBtn.addEventListener("click", () => {
      saveDraft();
      toast("MVP: Zahlung ist Demo. Stripe-Link später verdrahten.");
    });

    /* ---------- Init ---------- */
    loadDraft();
    ensureItems();
    syncInputs();
    renderTotals();

  </script>
</body>
                                                   </html>
