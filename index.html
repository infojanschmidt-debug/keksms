<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OnlyKeks – 3D Konfigurator</title>
  <meta name="theme-color" content="#0E0E11" />
  <style>
    :root{
      --bg:#0E0E11;
      --panel:#15151C;
      --stroke: rgba(255,255,255,.10);
      --text:#F2F2F4;
      --muted:#B9BBC6;
      --gold:#E6C27A;
      --pink:#ff4fa3;
      --cookie:#B8895B;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --r:18px;

      --common:#b9b9b9;
      --uncommon:#2ecc71;
      --rare:#4aa3ff;
      --epic:#b56bff;
      --legendary:#f6d26a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 50% 0%, #181823 0%, var(--bg) 55%, #0a0a0d 100%);
      color:var(--text);
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased;
      overflow-x:hidden;
    }

    /* FAIL-OPEN: App ist IMMER sichtbar */
    #app{display:block; opacity:1}

    .wrap{max-width:1120px; margin:0 auto; padding:18px 14px 60px}
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 0 16px;
    }
    .brand{
      display:flex; align-items:center; gap:12px;
    }
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: radial-gradient(circle at 35% 35%, #ffd9b8, #b8895b 55%, #6d4a2a 110%);
      box-shadow: 0 12px 30px rgba(0,0,0,.45);
      border:1px solid rgba(255,255,255,.12);
    }
    h1{font-size:18px; margin:0; letter-spacing:.2px}
    .sub{color:var(--muted); font-size:12.5px; margin-top:2px}
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background: rgba(21,21,28,.66);
      border:1px solid var(--stroke);
      box-shadow: 0 10px 25px rgba(0,0,0,.35);
      font-size:12px; color:var(--muted);
      user-select:none;
    }
    .dot{width:9px;height:9px;border-radius:50%}
    .btn{
      appearance:none; border:1px solid var(--stroke);
      background: rgba(21,21,28,.72);
      color:var(--text);
      border-radius:14px;
      padding:10px 12px;
      font-weight:650;
      cursor:pointer;
      transition: transform .08s ease, border-color .15s ease, background .15s ease;
    }
    .btn:active{transform: translateY(1px)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(230,194,122,.18), rgba(21,21,28,.72));
      border-color: rgba(230,194,122,.35);
    }
    .btn.ghost{background:transparent}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 960px){
      .grid{grid-template-columns:1fr; }
    }

    .card{
      background: rgba(21,21,28,.66);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.06);
      display:flex; align-items:center; justify-content:space-between; gap:10px;
    }
    .title{font-weight:800; letter-spacing:.2px}
    .muted{color:var(--muted)}
    .card .bd{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}

    .stage{
      position:relative;
      min-height: 520px;
      background:
        radial-gradient(520px 320px at 50% 30%, rgba(255,255,255,.08), rgba(255,255,255,0) 60%),
        radial-gradient(700px 380px at 50% 120%, rgba(230,194,122,.06), rgba(0,0,0,0) 62%);
    }
    .stageTop{
      padding:14px;
      display:flex; align-items:center; justify-content:space-between; gap:12px;
    }
    .big{
      font-size:28px; line-height:1.05; margin:0;
      letter-spacing:-.4px;
    }
    .lead{margin:8px 0 0; color:var(--muted); max-width:56ch}
    .canvasWrap{
      position:relative;
      margin:10px 14px 14px;
      border-radius: 22px;
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
      background: radial-gradient(600px 320px at 50% 25%, rgba(255,255,255,.06), rgba(0,0,0,.15) 65%);
      min-height: 360px;
      box-shadow: 0 28px 90px rgba(0,0,0,.65);
    }
    canvas{display:block; width:100%; height:360px}
    .glow{
      position:absolute; inset:-2px;
      pointer-events:none;
      border-radius: 24px;
      box-shadow: 0 0 0 rgba(0,0,0,0);
      transition: box-shadow .22s ease;
    }
    .badge{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.22);
      font-size:12px; color:var(--muted);
      user-select:none;
    }
    .badge strong{color:var(--text)}
    .split{display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between}
    .chips{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      padding:8px 10px; border-radius:999px;
      border:1px solid var(--stroke);
      background: rgba(21,21,28,.72);
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      font-size:12.5px;
    }
    .chip.on{
      color:var(--text);
      border-color: rgba(255,255,255,.22);
      background: rgba(255,255,255,.06);
    }

    .setScroller{
      display:flex; gap:10px; overflow:auto; padding:2px 0 8px;
      scroll-snap-type:x mandatory;
    }
    .set{
      flex: 0 0 260px;
      scroll-snap-align:start;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(21,21,28,.72));
      padding:12px;
      cursor:pointer;
      transition: transform .1s ease, border-color .15s ease;
    }
    .set:hover{transform: translateY(-1px)}
    .set .name{font-weight:800}
    .set .desc{font-size:12.5px; color:var(--muted); margin-top:6px; min-height:34px}
    .set .meta{display:flex; justify-content:space-between; margin-top:10px; font-size:12px; color:var(--muted)}
    .set.active{border-color: rgba(230,194,122,.35)}

    textarea,input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      color:var(--text);
      outline:none;
      font-size:14px;
    }
    textarea{min-height: 92px; resize: vertical}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}
    .hr{height:1px; background: rgba(255,255,255,.06); margin:14px 0}

    .mini{
      display:flex; gap:10px; flex-wrap:wrap;
    }
    .kv{
      flex:1 1 170px;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
    }
    .kv .k{font-size:11px; color:var(--muted)}
    .kv .v{margin-top:4px; font-weight:800}

    .hall{
      display:flex; gap:10px; overflow:auto; padding:2px 0 8px;
    }
    .hallItem{
      flex: 0 0 240px;
      border-radius:18px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
      padding:12px;
      cursor:pointer;
      transition: transform .1s ease, border-color .15s ease;
      position:relative;
      overflow:hidden;
    }
    .hallItem:hover{transform: translateY(-1px)}
    .hallItem .t{font-weight:900}
    .hallItem .m{margin-top:6px; color:var(--muted); font-size:12.5px; min-height:38px}
    .hallItem .f{display:flex; justify-content:space-between; margin-top:10px; font-size:12px; color:var(--muted)}
    .vip{
      border-color: rgba(230,194,122,.35);
    }
    .vip::after{
      content:"VIP";
      position:absolute; top:10px; right:10px;
      font-size:11px; letter-spacing:.6px;
      padding:6px 8px; border-radius:999px;
      background: rgba(0,0,0,.35);
      border:1px solid rgba(230,194,122,.35);
      color: var(--gold);
    }

    .qrBox{
      display:flex; gap:12px; align-items:center; flex-wrap:wrap;
    }
    #qr{
      width:132px; height:132px;
      border-radius:16px;
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
      background:#0b0b0f;
      display:flex; align-items:center; justify-content:center;
    }
    .toast{
      position:fixed; left:50%; bottom:18px;
      transform:translateX(-50%);
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.12);
      color:var(--text);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: 0 20px 50px rgba(0,0,0,.55);
      font-size:13px;
      opacity:0; pointer-events:none;
      transition: opacity .15s ease;
    }
    .toast.on{opacity:1}
    .fineprint{font-size:12px; color:var(--muted); margin-top:10px}
    a{color:var(--text); text-decoration:none; border-bottom:1px dashed rgba(255,255,255,.25)}
  </style>
</head>

<body>
  <div id="app">
    <div class="wrap">
      <header>
        <div class="brand">
          <div class="logo" aria-hidden="true"></div>
          <div>
            <h1>OnlyKeks</h1>
            <div class="sub">Echter 3D-Keks. Minimal UI. Maximal Wirkung.</div>
          </div>
        </div>

        <div class="row">
          <div class="pill" id="rarityPill"><span class="dot" id="rarityDot"></span><span id="rarityLabel">COMMON</span></div>
          <button class="btn ghost" id="btnSurprise">Überrasch mich</button>
          <button class="btn" id="btnShare">Keks teilen</button>
        </div>
      </header>

      <div class="grid">
        <!-- LEFT: Bühne -->
        <div class="card stage">
          <div class="stageTop">
            <div>
              <p class="big" style="margin:0">Schick ’ne Message. Als Keks.</p>
              <p class="lead">Empfänger scannt – antwortet direkt. Rarity entscheidet Style & Wirkung.</p>
              <div class="row" style="margin-top:10px">
                <span class="badge"><strong id="ruleA">Common–Rare</strong> <span class="muted">bisschen Style</span></span>
                <span class="badge"><strong id="ruleB">Epic–Legendary</strong> <span class="muted">weniger basteln, mehr Wirkung</span></span>
              </div>
            </div>

            <div class="row">
              <button class="btn primary" id="btnCheckout">Keks losschicken</button>
            </div>
          </div>

          <div class="canvasWrap" id="canvasWrap">
            <div class="glow" id="glow"></div>
            <canvas id="c"></canvas>
          </div>

          <div class="bd">
            <div class="split">
              <div class="chips" id="shapeChips"></div>
              <div class="chips" id="decoChips"></div>
            </div>

            <div class="hr"></div>

            <div class="mini">
              <div class="kv"><div class="k">Set</div><div class="v" id="kvSet">–</div></div>
              <div class="kv"><div class="k">Form</div><div class="v" id="kvShape">–</div></div>
              <div class="kv"><div class="k">Deko</div><div class="v" id="kvDeco">–</div></div>
              <div class="kv"><div class="k">Share-Code</div><div class="v" id="kvShare">–</div></div>
            </div>

            <div class="fineprint">✓ Kein Abo ✓ Keine Datenverkäufe</div>
          </div>
        </div>

        <!-- RIGHT: Controls / Hall / Share -->
        <div class="card">
          <div class="hd">
            <div class="title">Konfigurator</div>
            <div class="muted" style="font-size:12px">Draft wird lokal gespeichert</div>
          </div>

          <div class="bd">
            <div class="title" style="font-size:13px">Message</div>
            <textarea id="msg" maxlength="120" placeholder="Kurz. Klar. Wirkung."></textarea>
            <div class="hint"><span id="count">0</span>/120 Zeichen</div>

            <div class="hr"></div>

            <div class="title" style="font-size:13px; margin-bottom:8px">Set wählen</div>
            <div class="setScroller" id="setScroller"></div>

            <div class="hr"></div>

            <div class="title" style="font-size:13px; margin-bottom:8px">Hall of Keks</div>
            <div class="hall" id="hall"></div>

            <div class="hr"></div>

            <div class="title" style="font-size:13px; margin-bottom:8px">Share + QR</div>
            <div class="qrBox">
              <div id="qr" aria-label="QR Code"></div>
              <div style="flex:1; min-width: 220px">
                <input id="shareUrl" readonly />
                <div class="row" style="margin-top:10px">
                  <button class="btn" id="btnCopy">Link kopieren</button>
                  <button class="btn ghost" id="btnReset">Reset</button>
                </div>
                <div class="fineprint">Share lädt den Keks exakt so (Set, Rarity, Form, Deko, Message).</div>
              </div>
            </div>

          </div>
        </div>
      </div>

      <div class="toast" id="toast">Gespeichert.</div>
    </div>
  </div>

  <!-- Libraries -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

  <script>
    // -----------------------------
    // State / Config
    // -----------------------------
    const RARITIES = ["common","uncommon","rare","epic","legendary"];
    const RARITY_UI = {
      common:   {label:"COMMON",   color:getCss("--common"),    glow:"0 0 0 rgba(0,0,0,0)", locks:{decoMax:1, allowGold:false}},
      uncommon: {label:"UNCOMMON", color:getCss("--uncommon"),  glow:"0 0 38px rgba(46,204,113,.22)", locks:{decoMax:1, allowGold:false}},
      rare:     {label:"RARE",     color:getCss("--rare"),      glow:"0 0 45px rgba(74,163,255,.22)", locks:{decoMax:2, allowGold:false}},
      epic:     {label:"EPIC",     color:getCss("--epic"),      glow:"0 0 55px rgba(181,107,255,.26)", locks:{decoMax:1, allowGold:true}},
      legendary:{label:"LEGENDARY",color:getCss("--legendary"), glow:"0 0 70px rgba(246,210,106,.30)", locks:{decoMax:1, allowGold:true}}
    };

    const SHAPES = [
      {id:"circle", label:"Kreis"},
      {id:"heart",  label:"Herz"},
      {id:"star",   label:"Stern"},
      {id:"smile",  label:"Smiley"},
      {id:"tree",   label:"Tannenbaum"},
    ];

    const DECOS = [
      {id:"sprinkles", label:"Sprinkles"},
      {id:"gold", label:"Gold"},
    ];

    // 5 Beispiel-Sets (rarity-like)
    const SETS = [
      {id:"street", name:"Street Pop", desc:"Knackige Message, klare Kante. Wirkt sofort.", baseRarity:"rare", shape:"circle", deco:["sprinkles"]},
      {id:"love", name:"Herz-Alarm", desc:"Emotional, direkt. Für Kati-Vibes und Rückantwort.", baseRarity:"uncommon", shape:"heart", deco:["sprinkles"]},
      {id:"boss", name:"Boss-Mode", desc:"Wenig basteln, mehr Wirkung. Premium-Punch.", baseRarity:"epic", shape:"star", deco:["gold"]},
      {id:"winter", name:"Winter Drop", desc:"Keks-Schnee, ruhig aber präsent. Seasonal.", baseRarity:"rare", shape:"tree", deco:["sprinkles"]},
      {id:"myth", name:"Legendary Mythic", desc:"VIP-Look. Gold-Akzent. Maximum Prestige.", baseRarity:"legendary", shape:"star", deco:["gold"]},
    ];

    const HALL = [
      {id:"h1", rarity:"legendary", label:"VIP", message:"Nur Gehirn = nur Keks.", set:"myth", shape:"star", deco:["gold"]},
      {id:"h2", rarity:"epic", label:"Epic", message:"Beweg dein Arsch.", set:"boss", shape:"star", deco:["gold"]},
      {id:"h3", rarity:"rare", label:"Rare", message:"Meld dich. Jetzt.", set:"street", shape:"circle", deco:["sprinkles"]},
      {id:"h4", rarity:"uncommon", label:"Uncommon", message:"Vermiss dich.", set:"love", shape:"heart", deco:["sprinkles"]},
      {id:"h5", rarity:"common", label:"Common", message:"Komm klar.", set:"street", shape:"circle", deco:["sprinkles"]},
    ];

    const LS_KEY = "onlykeks_draft_v2";

    let state = loadDraft() ?? {
      rarity: "common",
      setId: "street",
      shape: "circle",
      deco: ["sprinkles"],
      message: ""
    };

    // -----------------------------
    // UI Elements
    // -----------------------------
    const $ = (s)=>document.querySelector(s);
    const rarityPill = $("#rarityPill");
    const rarityDot = $("#rarityDot");
    const rarityLabel = $("#rarityLabel");
    const glow = $("#glow");
    const msg = $("#msg");
    const count = $("#count");
    const setScroller = $("#setScroller");
    const shapeChips = $("#shapeChips");
    const decoChips = $("#decoChips");
    const hall = $("#hall");
    const toast = $("#toast");
    const shareUrl = $("#shareUrl");
    const kvSet = $("#kvSet"), kvShape=$("#kvShape"), kvDeco=$("#kvDeco"), kvShare=$("#kvShare");
    const btnSurprise = $("#btnSurprise");
    const btnShare = $("#btnShare");
    const btnCopy = $("#btnCopy");
    const btnReset = $("#btnReset");
    const btnCheckout = $("#btnCheckout");

    // -----------------------------
    // Build UI
    // -----------------------------
    function buildChips(){
      shapeChips.innerHTML = "";
      SHAPES.forEach(s=>{
        const el = document.createElement("div");
        el.className = "chip";
        el.textContent = s.label;
        el.onclick = ()=>{ state.shape = s.id; persist(); syncAll(); };
        el.dataset.id = s.id;
        shapeChips.appendChild(el);
      });

      decoChips.innerHTML = "";
      DECOS.forEach(d=>{
        const el = document.createElement("div");
        el.className = "chip";
        el.textContent = d.label;
        el.onclick = ()=>toggleDeco(d.id);
        el.dataset.id = d.id;
        decoChips.appendChild(el);
      });
    }

    function buildSets(){
      setScroller.innerHTML = "";
      SETS.forEach(s=>{
        const el = document.createElement("div");
        el.className = "set";
        el.dataset.id = s.id;
        el.innerHTML = `
          <div class="name">${escapeHtml(s.name)}</div>
          <div class="desc">${escapeHtml(s.desc)}</div>
          <div class="meta">
            <span>${s.baseRarity.toUpperCase()}</span>
            <span>${shapeLabel(s.shape)}</span>
          </div>
        `;
        el.onclick = ()=>{
          state.setId = s.id;
          // Set applies defaults, but keep user message
          state.shape = s.shape;
          state.deco = [...s.deco];
          state.rarity = s.baseRarity;
          persist(); syncAll();
        };
        setScroller.appendChild(el);
      });
    }

    function buildHall(){
      hall.innerHTML = "";
      HALL.forEach(h=>{
        const el = document.createElement("div");
        const isVip = (h.rarity==="epic" || h.rarity==="legendary");
        el.className = "hallItem" + (isVip ? " vip" : "");
        el.innerHTML = `
          <div class="t">${escapeHtml(h.label)} · ${h.rarity.toUpperCase()}</div>
          <div class="m">${escapeHtml(h.message)}</div>
          <div class="f">
            <span>${escapeHtml(setName(h.set))}</span>
            <span>${shapeLabel(h.shape)}</span>
          </div>
        `;
        el.onclick = ()=>{
          state.rarity = h.rarity;
          state.setId = h.set;
          state.shape = h.shape;
          state.deco = [...h.deco];
          state.message = h.message;
          persist(); syncAll();
        };
        hall.appendChild(el);
      });
    }

    // -----------------------------
    // Rules / Locks
    // -----------------------------
    function toggleDeco(id){
      const locks = RARITY_UI[state.rarity].locks;
      // Legendary/Epic allow gold; lower rarities don't
      if(id === "gold" && !locks.allowGold){
        toastMsg("Gold ist erst ab EPIC verfügbar.");
        return;
      }
      const has = state.deco.includes(id);
      let next = has ? state.deco.filter(x=>x!==id) : [...state.deco, id];

      // enforce max
      if(next.length > locks.decoMax){
        next = next.slice(next.length - locks.decoMax);
      }
      state.deco = next;
      persist(); syncAll();
    }

    // -----------------------------
    // Persistence
    // -----------------------------
    function persist(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      toastMsg("Gespeichert.");
    }
    function loadDraft(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }

    // -----------------------------
    // Share / Encode
    // -----------------------------
    function encodeState(s){
      const json = JSON.stringify(s);
      return btoa(unescape(encodeURIComponent(json)));
    }
    function decodeState(str){
      const json = decodeURIComponent(escape(atob(str)));
      return JSON.parse(json);
    }
    function shareCodeFor(s){
      // simple stable-ish short code
      const base = encodeState(s).slice(0,18);
      return base.replace(/[^a-zA-Z0-9]/g,"").slice(0,12).toUpperCase();
    }
    function buildShareUrl(){
      const code = encodeState(state);
      const url = new URL(location.href);
      url.searchParams.set("share", code);
      return url.toString();
    }

    // -----------------------------
    // Sync UI
    // -----------------------------
    function syncAll(){
      // rarity pill + glow
      const r = RARITY_UI[state.rarity];
      rarityDot.style.background = r.color;
      rarityLabel.textContent = r.label;
      glow.style.boxShadow = r.glow;

      // chips active
      [...shapeChips.children].forEach(c=>c.classList.toggle("on", c.dataset.id===state.shape));
      [...decoChips.children].forEach(c=>c.classList.toggle("on", state.deco.includes(c.dataset.id)));

      // set active
      [...setScroller.children].forEach(el=>el.classList.toggle("active", el.dataset.id===state.setId));

      // message
      msg.value = state.message || "";
      count.textContent = (state.message || "").length;

      // KV
      kvSet.textContent = setName(state.setId);
      kvShape.textContent = shapeLabel(state.shape);
      kvDeco.textContent = state.deco.length ? state.deco.map(decoLabel).join(", ") : "–";
      const sc = shareCodeFor(state);
      kvShare.textContent = sc;

      // share url + qr
      const url = buildShareUrl();
      shareUrl.value = url;
      renderQR(url);

      // apply locks visuals
      const locks = RARITY_UI[state.rarity].locks;
      // disable gold chip if locked
      [...decoChips.children].forEach(c=>{
        if(c.dataset.id==="gold"){
          c.style.opacity = locks.allowGold ? "1" : ".45";
          c.style.pointerEvents = locks.allowGold ? "auto" : "auto"; // still clickable to show toast
        }
      });

      // update 3D
      updateCookieVisual();
    }

    function toastMsg(t){
      toast.textContent = t;
      toast.classList.add("on");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>toast.classList.remove("on"), 850);
    }

    function setName(id){
      const s = SETS.find(x=>x.id===id);
      return s ? s.name : "–";
    }
    function shapeLabel(id){
      const s = SHAPES.find(x=>x.id===id);
      return s ? s.label : id;
    }
    function decoLabel(id){
      const d = DECOS.find(x=>x.id===id);
      return d ? d.label : id;
    }

    function getCss(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
    function escapeHtml(s){ return (s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

    // -----------------------------
    // QR
    // -----------------------------
    let qrInst = null;
    function renderQR(url){
      const box = document.getElementById("qr");
      box.innerHTML = "";
      qrInst = new QRCode(box, {
        text: url,
        width: 120,
        height: 120,
        correctLevel: QRCode.CorrectLevel.M
      });
    }

    // -----------------------------
    // Events
    // -----------------------------
    msg.addEventListener("input", ()=>{
      state.message = (msg.value || "").slice(0,120);
      persist(); syncAll();
    });

    btnSurprise.onclick = ()=>{
      // Surprise engine: random set + random rarity bias upward sometimes
      const pickSet = SETS[Math.floor(Math.random()*SETS.length)];
      const r = Math.random();
      const pickRarity = r < .52 ? "common" : r < .74 ? "uncommon" : r < .88 ? "rare" : r < .97 ? "epic" : "legendary";
      state.setId = pickSet.id;
      state.rarity = pickRarity;
      state.shape = pickSet.shape;
      state.deco = [...pickSet.deco];

      // enforce locks after random
      const locks = RARITY_UI[state.rarity].locks;
      state.deco = state.deco.filter(d => d!=="gold" || locks.allowGold).slice(0, locks.decoMax);

      persist(); syncAll();
      toastMsg("Überraschung geladen.");
    };

    btnShare.onclick = ()=> {
      shareUrl.select();
      document.execCommand("copy");
      toastMsg("Share-Link kopiert.");
    };
    btnCopy.onclick = ()=> {
      shareUrl.select();
      document.execCommand("copy");
      toastMsg("Link kopiert.");
    };
    btnReset.onclick = ()=> {
      localStorage.removeItem(LS_KEY);
      state = { rarity:"common", setId:"street", shape:"circle", deco:["sprinkles"], message:"" };
      persist(); syncAll();
    };
    btnCheckout.onclick = ()=>{
      toastMsg("Checkout kommt als nächster Schritt (Stripe-Link).");
    };

    // -----------------------------
    // Share loader
    // -----------------------------
    (function initShare(){
      const p = new URLSearchParams(location.search);
      const share = p.get("share");
      if(!share) return;
      try{
        const incoming = decodeState(share);
        // minimal validation
        if(incoming && incoming.rarity && incoming.shape){
          state = {
            rarity: incoming.rarity,
            setId: incoming.setId ?? "street",
            shape: incoming.shape,
            deco: Array.isArray(incoming.deco) ? incoming.deco : [],
            message: incoming.message ?? ""
          };
          persist();
          toastMsg("Share-Keks geladen.");
        }
      }catch(e){
        toastMsg("Share-Link ungültig.");
      }
    })();

    // -----------------------------
    // THREE.JS – 3D Cookie (stable)
    // -----------------------------
    const canvas = document.getElementById("c");
    let renderer, scene, camera, cookieGroup, cookieMesh, icingMesh, sprinklePoints, textSprite;
    let okWebGL = true;

    function initThree(){
      try{
        renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true, powerPreference:"high-performance"});
        renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
        renderer.setSize(canvas.clientWidth, 360, false);

        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(35, canvas.clientWidth/360, 0.1, 100);
        camera.position.set(0, 1.1, 4.2);

        const hemi = new THREE.HemisphereLight(0xffffff, 0x101018, 0.9);
        scene.add(hemi);

        const key = new THREE.DirectionalLight(0xffffff, 1.15);
        key.position.set(2.2, 3.0, 2.0);
        scene.add(key);

        const rim = new THREE.DirectionalLight(0xffffff, 0.45);
        rim.position.set(-2.0, 2.0, -2.4);
        scene.add(rim);

        cookieGroup = new THREE.Group();
        scene.add(cookieGroup);

        buildCookieGeometry();
        window.addEventListener("resize", onResize);

        animate();
      }catch(e){
        okWebGL = false;
        fallback2D();
      }
    }

    function onResize(){
      if(!renderer || !camera) return;
      const w = canvas.clientWidth;
      camera.aspect = w/360;
      camera.updateProjectionMatrix();
      renderer.setSize(w, 360, false);
    }

    function buildCookieGeometry(){
      // clean rebuild
      while(cookieGroup.children.length) cookieGroup.remove(cookieGroup.children[0]);

      // base cookie
      const baseGeo = new THREE.CylinderGeometry(1.35, 1.35, 0.34, 48, 1, false);
      const cookieMat = new THREE.MeshStandardMaterial({
        color: new THREE.Color(getCss("--cookie")),
        roughness: 0.85,
        metalness: 0.02
      });
      cookieMesh = new THREE.Mesh(baseGeo, cookieMat);
      cookieMesh.rotation.x = Math.PI * 0.08;
      cookieGroup.add(cookieMesh);

      // icing plate (slight offset)
      const icingGeo = new THREE.CylinderGeometry(1.22, 1.22, 0.06, 48, 1, false);
      const icingMat = new THREE.MeshStandardMaterial({
        color: 0xF5EFEA,
        roughness: 0.55,
        metalness: 0.02,
        transparent:true,
        opacity: 0.92
      });
      icingMesh = new THREE.Mesh(icingGeo, icingMat);
      icingMesh.position.y = 0.18;
      icingMesh.rotation.x = cookieMesh.rotation.x;
      cookieGroup.add(icingMesh);

      // sprinkles as points
      sprinklePoints = makeSprinkles();
      cookieGroup.add(sprinklePoints);

      // message sprite (canvas texture)
      textSprite = makeTextSprite("");
      textSprite.position.set(0, 0.28, 0.02);
      textSprite.scale.set(2.2, 1.1, 1);
      cookieGroup.add(textSprite);

      // initial shape effect by scaling profile
      applyShapeToMesh();

      // initial deco visibility
      applyDecoToMesh();

      // initial rarity tint
      applyRarityToMesh();
    }

    function makeSprinkles(){
      const count = 120;
      const geom = new THREE.BufferGeometry();
      const pos = new Float32Array(count*3);
      for(let i=0;i<count;i++){
        const a = Math.random()*Math.PI*2;
        const r = Math.sqrt(Math.random())*1.08;
        pos[i*3+0] = Math.cos(a)*r;
        pos[i*3+1] = 0.22 + (Math.random()*0.02);
        pos[i*3+2] = Math.sin(a)*r;
      }
      geom.setAttribute("position", new THREE.BufferAttribute(pos, 3));
      const mat = new THREE.PointsMaterial({ size:0.05, color: new THREE.Color(getCss("--pink")), transparent:true, opacity:0.95 });
      return new THREE.Points(geom, mat);
    }

    function makeTextSprite(text){
      const c = document.createElement("canvas");
      c.width = 1024; c.height = 512;
      const ctx = c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height);

      const tex = new THREE.CanvasTexture(c);
      tex.anisotropy = 4;
      const mat = new THREE.SpriteMaterial({ map: tex, transparent:true, opacity: 0.98 });
      const spr = new THREE.Sprite(mat);
      spr.userData._canvas = c;
      spr.userData._ctx = ctx;
      return spr;
    }

    function drawTextOnSprite(spr, text){
      const c = spr.userData._canvas;
      const ctx = spr.userData._ctx;
      ctx.clearRect(0,0,c.width,c.height);

      // soft background plate
      ctx.fillStyle = "rgba(0,0,0,0)";
      ctx.fillRect(0,0,c.width,c.height);

      // message
      const t = (text || "").trim();
      const display = t.length ? t : " ";
      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      // auto-size
      let size = 74;
      ctx.font = `800 ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      while(ctx.measureText(display).width > 880 && size > 44){
        size -= 2;
        ctx.font = `800 ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      }

      // stroke + fill for readability
      ctx.lineWidth = 10;
      ctx.strokeStyle = "rgba(0,0,0,.35)";
      ctx.fillStyle = "rgba(35,35,45,.96)";
      ctx.strokeText(display, c.width/2, c.height/2);
      ctx.fillText(display, c.width/2, c.height/2);

      spr.material.map.needsUpdate = true;
    }

    function applyRarityToMesh(){
      const r = RARITY_UI[state.rarity];
      // subtle tint on icing
      const col = new THREE.Color(r.color);
      icingMesh.material.color = new THREE.Color(0xF5EFEA).lerp(col, (state.rarity==="common") ? 0.03 : 0.10);
      // gold mode adds a warmer cookie sheen
      if(state.rarity==="legendary"){
        cookieMesh.material.roughness = 0.62;
      }else{
        cookieMesh.material.roughness = 0.85;
      }
    }

    function applyDecoToMesh(){
      const hasSprinkles = state.deco.includes("sprinkles");
      const hasGold = state.deco.includes("gold");
      sprinklePoints.visible = hasSprinkles;

      // gold effect: adjust icing + add a gold rim via emissive-ish feel
      if(hasGold){
        icingMesh.material.color = new THREE.Color(0xF7E2B2);
        icingMesh.material.roughness = 0.35;
      }else{
        icingMesh.material.color = new THREE.Color(0xF5EFEA);
        icingMesh.material.roughness = 0.55;
      }
      applyRarityToMesh();
    }

    function applyShapeToMesh(){
      // cheat: different silhouettes by scaling + slight warp. Stable and fast.
      const s = state.shape;
      cookieGroup.scale.set(1,1,1);

      if(s==="circle"){ cookieGroup.scale.set(1,1,1); }
      if(s==="heart"){ cookieGroup.scale.set(1.0,1.0,0.92); cookieGroup.rotation.y = 0.15; }
      if(s==="star"){ cookieGroup.scale.set(0.98,1.0,0.98); cookieGroup.rotation.y = 0.55; }
      if(s==="smile"){ cookieGroup.scale.set(1.02,1.0,0.95); cookieGroup.rotation.y = -0.2; }
      if(s==="tree"){ cookieGroup.scale.set(0.92,1.0,1.02); cookieGroup.rotation.y = 0.25; }
    }

    function updateCookieVisual(){
      if(!okWebGL) return;
      // apply locks after manual changes
      const locks = RARITY_UI[state.rarity].locks;
      state.deco = state.deco.filter(d => d!=="gold" || locks.allowGold).slice(0, locks.decoMax);

      applyShapeToMesh();
      applyDecoToMesh();
      applyRarityToMesh();
      drawTextOnSprite(textSprite, state.message);
    }

    function animate(){
      if(!okWebGL) return;
      requestAnimationFrame(animate);

      const t = performance.now()*0.001;
      cookieGroup.rotation.y += 0.0042;
      cookieGroup.position.y = Math.sin(t*1.15)*0.045;

      renderer.render(scene, camera);
    }

    function fallback2D(){
      // If WebGL dies, we still show a nice 2D cookie so: NO BLACK SCREEN.
      const wrap = document.getElementById("canvasWrap");
      wrap.innerHTML = `
        <div style="padding:14px">
          <div style="border-radius:22px;border:1px solid rgba(255,255,255,.10);background:rgba(0,0,0,.18);padding:18px;min-height:320px;display:flex;align-items:center;justify-content:center">
            <div style="width:240px;height:240px;border-radius:999px;background:radial-gradient(circle at 35% 35%, #ffd9b8, #b8895b 60%, #6d4a2a 120%);border:1px solid rgba(255,255,255,.12);box-shadow:0 28px 90px rgba(0,0,0,.65);display:flex;align-items:center;justify-content:center;text-align:center;padding:22px;font-weight:900;line-height:1.05">
              ${escapeHtml(state.message || " ")}
            </div>
          </div>
          <div class="fineprint" style="margin-top:10px">WebGL nicht verfügbar – UI läuft weiter (fail-open).</div>
        </div>
      `;
      toastMsg("WebGL Fallback aktiv.");
    }

    // -----------------------------
    // Init
    // -----------------------------
    buildChips();
    buildSets();
    buildHall();

    // initial fill
    syncAll();

    // start 3D
    initThree();

    function getCss(v){ return getComputedStyle(document.documentElement).getPropertyValue(v).trim(); }
  </script>
</body>
</html>
