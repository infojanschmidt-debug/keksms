<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OnlyKeks – Post, die schmeckt.</title>
  <meta name="theme-color" content="#FBF3E6" />
  <style>
    :root{
      /* Warm, essbar, ruhig */
      --vanilla:#FBF3E6;
      --vanilla-2:#FFF8EE;
      --cream:#FFFDF8;

      --cookie:#B8895B;
      --cookie-2:#A97749;
      --cocoa:#6A4428;

      --ink:#1E1A16;
      --muted:#6C625A;

      --stroke: rgba(30,26,22,.12);
      --stroke2: rgba(30,26,22,.08);

      --accent:#E9A4B4;   /* soft rosé */
      --accent2:#D68FA0;

      --r:18px;
      --shadow: 0 18px 55px rgba(30,26,22,.10);
      --shadow2: 0 12px 28px rgba(30,26,22,.08);

      --bg: radial-gradient(1200px 680px at 50% 0%, #fffaf2 0%, var(--vanilla) 55%, #f6ead8 110%);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: var(--bg);
      color:var(--ink);
      font-family: ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
      -webkit-font-smoothing:antialiased;
      overflow-x:hidden;
    }

    a{color:inherit; text-decoration:none; border-bottom:1px dashed rgba(30,26,22,.25)}
    .wrap{max-width:1160px; margin:0 auto; padding:18px 14px 90px}

    /* Header */
    header{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:10px 0 18px;
    }
    .brand{display:flex; align-items:center; gap:12px;}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: radial-gradient(circle at 35% 35%, #ffe1c7, var(--cookie) 58%, #6d4a2a 125%);
      border:1px solid rgba(30,26,22,.10);
      box-shadow: 0 10px 30px rgba(30,26,22,.10);
    }
    .brand h1{font-size:16px; margin:0; letter-spacing:.2px}
    .sub{font-size:12.5px; color:var(--muted); margin-top:2px}

    .topActions{display:flex; align-items:center; gap:10px; flex-wrap:wrap}
    .btn{
      appearance:none;
      border:1px solid var(--stroke);
      background: rgba(255,255,255,.65);
      color:var(--ink);
      border-radius:14px;
      padding:10px 12px;
      font-weight:850;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      box-shadow: 0 10px 24px rgba(30,26,22,.06);
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{
      background: linear-gradient(180deg, rgba(233,164,180,.62), rgba(255,255,255,.70));
      border-color: rgba(214,143,160,.55);
      box-shadow: 0 16px 36px rgba(214,143,160,.18);
    }
    .btn.ghost{
      background: transparent;
      box-shadow:none;
    }

    /* Layout */
    .grid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns:1fr;}
    }

    /* Cards */
    .card{
      background: rgba(255,255,255,.68);
      border:1px solid var(--stroke);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(6px);
    }
    .hd{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--stroke2);
      display:flex; align-items:flex-start; justify-content:space-between; gap:10px;
    }
    .title{font-weight:950; letter-spacing:.2px}
    .muted{color:var(--muted)}
    .bd{padding:14px}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .hr{height:1px; background: var(--stroke2); margin:14px 0}

    /* Hero */
    .heroTop{
      padding:16px 16px 12px;
      display:flex; align-items:flex-start; justify-content:space-between; gap:12px;
    }
    .hBig{
      font-size:40px; line-height:1.02; margin:0;
      letter-spacing:-.8px;
    }
    .lead{
      margin:10px 0 0;
      color:var(--muted);
      max-width:62ch;
      font-size:15px;
    }
    .heroMeta{
      margin-top:12px;
      display:flex; gap:8px; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding:8px 10px; border-radius:999px;
      background: rgba(255,255,255,.72);
      border:1px solid rgba(30,26,22,.10);
      font-size:12px; color:var(--muted);
      box-shadow: 0 10px 24px rgba(30,26,22,.05);
    }
    .dot{width:8px;height:8px;border-radius:50%; background: var(--accent)}

    /* Stage */
    .stageWrap{
      position:relative;
      margin:10px 14px 14px;
      border-radius: 22px;
      border: 1px solid rgba(30,26,22,.10);
      overflow:hidden;
      background:
        radial-gradient(760px 360px at 50% 18%, rgba(255,255,255,.85), rgba(255,255,255,0) 62%),
        radial-gradient(980px 460px at 50% 125%, rgba(184,137,91,.18), rgba(0,0,0,0) 62%),
        linear-gradient(180deg, rgba(255,248,238,.82), rgba(255,255,255,.50));
      min-height: 460px;
      box-shadow: 0 26px 70px rgba(30,26,22,.10);
    }
    .stageWrap::after{
      /* Tisch-/Kontaktgefühl unten */
      content:"";
      position:absolute; left:0; right:0; bottom:0; height:46%;
      background: radial-gradient(70% 60% at 50% 0%, rgba(30,26,22,.08), rgba(30,26,22,0) 60%);
      opacity:.35;
      pointer-events:none;
    }
    canvas{display:block; width:100%; height:460px}

    .stageHint{
      position:absolute; left:14px; bottom:12px;
      display:flex; gap:8px; flex-wrap:wrap;
      pointer-events:none;
    }

    /* Controls */
    label{display:block; font-size:12.5px; font-weight:950; margin:0 0 8px}
    textarea,input{
      width:100%;
      padding:12px 12px;
      border-radius:14px;
      border:1px solid rgba(30,26,22,.12);
      background: rgba(255,255,255,.78);
      color:var(--ink);
      outline:none;
      font-size:14px;
    }
    textarea{min-height:92px; resize:vertical}
    .hint{font-size:12px; color:var(--muted); margin-top:8px}

    .chipRow{display:flex; gap:8px; flex-wrap:wrap}
    .chip{
      padding:8px 10px; border-radius:999px;
      border:1px solid rgba(30,26,22,.12);
      background: rgba(255,255,255,.66);
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      font-size:12.5px;
      transition: transform .08s ease, background .15s ease, border-color .15s ease, box-shadow .15s ease;
      box-shadow: 0 10px 22px rgba(30,26,22,.04);
    }
    .chip:active{transform: translateY(1px)}
    .chip.on{
      color:var(--ink);
      border-color: rgba(214,143,160,.55);
      background: rgba(233,164,180,.22);
      box-shadow: 0 12px 26px rgba(214,143,160,.12);
    }

    /* Quick templates */
    .templates{display:flex; gap:8px; flex-wrap:wrap}
    .tpl{
      padding:8px 10px; border-radius:999px;
      border:1px dashed rgba(30,26,22,.18);
      background: rgba(255,255,255,.60);
      cursor:pointer;
      font-size:12.5px;
      color:var(--muted);
    }
    .tpl:hover{color:var(--ink)}

    /* Hall */
    .hall{
      display:flex; gap:10px; overflow:auto; padding:2px 0 8px;
      scroll-snap-type:x mandatory;
    }
    .hallItem{
      flex:0 0 280px;
      scroll-snap-align:start;
      border-radius:18px;
      border:1px solid rgba(30,26,22,.10);
      background: rgba(255,255,255,.70);
      padding:12px;
      cursor:pointer;
      transition: transform .12s ease, box-shadow .15s ease, border-color .15s ease;
      box-shadow: var(--shadow2);
      position:relative;
    }
    .hallItem:hover{
      transform:translateY(-2px);
      box-shadow: 0 18px 40px rgba(30,26,22,.12);
      border-color: rgba(214,143,160,.28);
    }
    .hallTop{display:flex; gap:10px; align-items:center}
    .miniCookie{
      width:44px; height:44px; border-radius:999px;
      background: radial-gradient(circle at 35% 35%, #ffe1c7, var(--cookie) 62%, #6d4a2a 125%);
      border:1px solid rgba(30,26,22,.10);
      box-shadow: 0 12px 26px rgba(30,26,22,.12);
      flex:0 0 auto;
      position:relative;
      overflow:hidden;
    }
    .miniCookie::after{
      content:"";
      position:absolute; inset:9px;
      border-radius:999px;
      background: rgba(255,255,255,.72);
      opacity:.55;
    }
    .hallItem .t{font-weight:950}
    .hallItem .m{margin-top:8px; color:var(--muted); font-size:13px; min-height:38px}
    .tags{display:flex; gap:6px; flex-wrap:wrap; margin-top:10px}
    .tag{
      font-size:11.5px;
      padding:6px 8px;
      border-radius:999px;
      border:1px solid rgba(30,26,22,.10);
      background: rgba(255,255,255,.62);
      color:var(--muted);
    }

    /* Trust */
    .trustBar{
      display:grid; gap:10px;
      grid-template-columns: repeat(3, minmax(0,1fr));
      padding:14px;
    }
    @media (max-width: 780px){
      .trustBar{grid-template-columns:1fr;}
    }
    .trust{
      border:1px solid rgba(30,26,22,.10);
      background: rgba(255,255,255,.70);
      border-radius:16px;
      padding:12px;
      box-shadow: var(--shadow2);
      display:flex; gap:10px; align-items:flex-start;
    }
    .ico{
      width:28px; height:28px; border-radius:10px;
      border:1px solid rgba(30,26,22,.10);
      background: rgba(233,164,180,.22);
      flex:0 0 auto;
    }
    .trust b{display:block; font-weight:950}
    .trust span{color:var(--muted); font-size:12.5px}

    /* FAQ */
    details{
      border:1px solid rgba(30,26,22,.10);
      background: rgba(255,255,255,.70);
      border-radius:16px;
      padding:12px;
      box-shadow: var(--shadow2);
    }
    details + details{margin-top:10px}
    summary{cursor:pointer; font-weight:950}
    summary::-webkit-details-marker{display:none}
    details p{margin:10px 0 0; color:var(--muted); font-size:13.5px}

    /* Modal Checkout */
    .modal{
      position:fixed; inset:0;
      background: rgba(30,26,22,.35);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal.on{display:flex}
    .modalCard{
      width:min(760px, 100%);
      border-radius:22px;
      background: rgba(255,255,255,.94);
      border:1px solid rgba(30,26,22,.14);
      box-shadow: 0 30px 90px rgba(30,26,22,.25);
      overflow:hidden;
    }
    .modalHd{
      padding:14px 14px 10px;
      display:flex; justify-content:space-between; align-items:center; gap:12px;
      border-bottom:1px solid rgba(30,26,22,.10);
    }
    .x{border:1px solid rgba(30,26,22,.12); background:transparent; border-radius:12px; padding:8px 10px; cursor:pointer; font-weight:950}
    .modalBd{padding:14px}
    .summaryGrid{
      display:grid; gap:10px;
      grid-template-columns: 1fr 1fr;
    }
    @media (max-width: 720px){
      .summaryGrid{grid-template-columns:1fr;}
    }
    .kv{
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(30,26,22,.10);
      background: rgba(255,255,255,.78);
    }
    .kv .k{font-size:11px; color:var(--muted)}
    .kv .v{margin-top:4px; font-weight:950}

    .fineprint{font-size:12px; color:var(--muted); margin-top:10px}

    /* Mobile sticky CTA */
    .stickyCta{
      position:fixed; left:0; right:0; bottom:0;
      padding:10px 12px;
      background: rgba(255,255,255,.82);
      border-top:1px solid rgba(30,26,22,.10);
      box-shadow: 0 -16px 40px rgba(30,26,22,.12);
      display:none;
      z-index:40;
      backdrop-filter: blur(8px);
    }
    .stickyInner{
      max-width:1160px; margin:0 auto;
      display:flex; gap:10px; align-items:center; justify-content:space-between;
    }
    .stickyText{font-size:12.5px; color:var(--muted)}
    @media (max-width: 980px){
      .stickyCta{display:block;}
      .wrap{padding-bottom:130px;}
    }

    /* Toast */
    .toast{
      position:fixed; left:50%; bottom:18px;
      transform:translateX(-50%);
      background: rgba(255,255,255,.92);
      border:1px solid rgba(30,26,22,.12);
      color:var(--ink);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: 0 20px 50px rgba(30,26,22,.18);
      font-size:13px;
      opacity:0; pointer-events:none;
      transition: opacity .15s ease;
      z-index:60;
    }
    .toast.on{opacity:1}

    footer{
      margin-top:16px;
      display:flex; justify-content:space-between; gap:12px; flex-wrap:wrap;
      color:var(--muted);
      font-size:12.5px;
      padding:8px 2px 0;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>OnlyKeks</h1>
          <div class="sub">3D-Keks. Ruhig. Lecker. Geschenkbereit.</div>
        </div>
      </div>

      <div class="topActions">
        <button class="btn ghost" id="btnSurprise">Überrasch mich</button>
        <button class="btn" id="btnShare">Teilen</button>
        <button class="btn primary" id="btnCheckoutTop">Keks losschicken</button>
      </div>
    </header>

    <div class="grid">
      <!-- LEFT: Hero + 3D Stage -->
      <section class="card">
        <div class="heroTop">
          <div>
            <p class="hBig">Post, die schmeckt.</p>
            <p class="lead">Du schreibst eine Botschaft. Wir machen daraus einen echten Keks. Sieht gut aus. Schmeckt gut. Kommt als Geschenk an.</p>
            <div class="heroMeta">
              <span class="pill"><span class="dot"></span> 3D Vorschau (drehbar)</span>
              <span class="pill">Vanille & Keksbraun · Premium ruhig</span>
              <span class="pill">Kein Abo</span>
            </div>
          </div>
          <div class="row">
            <button class="btn primary" id="btnCheckout">Keks losschicken</button>
          </div>
        </div>

        <div class="stageWrap" id="stageWrap">
          <canvas id="c"></canvas>
          <div class="stageHint">
            <span class="pill">Tipp: Maus ziehen zum Drehen</span>
          </div>
        </div>

        <div class="bd">
          <div class="row" style="justify-content:space-between">
            <div class="muted" style="font-size:13px">Draft wird lokal gespeichert.</div>
            <div class="row">
              <button class="btn ghost" id="btnReset">Reset</button>
            </div>
          </div>
          <div class="fineprint">✓ Kein Abo ✓ Keine Datenverkäufe</div>
        </div>
      </section>

      <!-- RIGHT: Controls + Hall + Share -->
      <aside class="card">
        <div class="hd">
          <div class="title">Keks gestalten</div>
          <div class="muted" style="font-size:12px">Einfach & schnell.</div>
        </div>

        <div class="bd">
          <label for="msg">Deine Botschaft</label>
          <textarea id="msg" maxlength="90" placeholder="Kurz. Klar. Lecker. (z.B. „Vermiss dich.“)"></textarea>
          <div class="hint"><span id="count">0</span>/90 Zeichen</div>

          <div class="row" style="margin-top:10px">
            <div class="templates" id="templates"></div>
          </div>

          <div class="hr"></div>

          <label>Form</label>
          <div class="chipRow" id="shapeChips"></div>

          <div class="hr"></div>

          <label>Extras</label>
          <div class="chipRow" id="decoChips"></div>
          <div class="hint">Max. 2 Extras – weniger ist mehr.</div>

          <div class="hr"></div>

          <label>Hall of Keks</label>
          <div class="hall" id="hall"></div>

          <div class="hr"></div>

          <label for="shareUrl">Teilen</label>
          <input id="shareUrl" readonly />
          <div class="row" style="margin-top:10px">
            <button class="btn" id="btnCopy">Link kopieren</button>
            <button class="btn ghost" id="btnScrollTop">Nach oben</button>
          </div>
          <div class="hint">Der Link öffnet deinen Keks exakt so (Form, Extras, Text).</div>
        </div>
      </aside>
    </div>

    <!-- Trust / FAQ -->
    <section class="trustBar" style="margin-top:14px">
      <div class="trust">
        <div class="ico" aria-hidden="true"></div>
        <div>
          <b>Lebensmittel & Allergene</b>
          <span>Transparent vor dem Kauf. Klar kommuniziert.</span>
        </div>
      </div>
      <div class="trust">
        <div class="ico" aria-hidden="true"></div>
        <div>
          <b>Sicher bezahlen</b>
          <span>Kein Abo. Kein Datenverkauf. Einfacher Checkout.</span>
        </div>
      </div>
      <div class="trust">
        <div class="ico" aria-hidden="true"></div>
        <div>
          <b>Geschenk-Logik</b>
          <span>Sieht gut aus. Schmeckt gut. Kommt gut an.</span>
        </div>
      </div>
    </section>

    <section class="card" style="margin-top:14px">
      <div class="hd">
        <div class="title">FAQ</div>
        <div class="muted" style="font-size:12px">Kurz & klar.</div>
      </div>
      <div class="bd">
        <details>
          <summary>Wie lange dauert der Versand?</summary>
          <p>Typisch 2–4 Werktage. Du siehst vor der Zahlung die genauen Infos.</p>
        </details>
        <details>
          <summary>Ist das ein Abo?</summary>
          <p>Nein. Einmal gestalten, einmal verschicken. Fertig.</p>
        </details>
        <details>
          <summary>Kann ich den Link teilen?</summary>
          <p>Ja. Der Share-Link lädt deinen Keks exakt so, wie du ihn gestaltet hast.</p>
        </details>
      </div>
    </section>

    <footer>
      <div>© OnlyKeks</div>
      <div>
        <a href="#impressum">Impressum</a> · <a href="#datenschutz">Datenschutz</a> · <a href="#agb">AGB</a>
      </div>
    </footer>
  </div>

  <!-- Mobile Sticky CTA -->
  <div class="stickyCta">
    <div class="stickyInner">
      <div class="stickyText">Dein Keks ist bereit. Jetzt losschicken.</div>
      <button class="btn primary" id="btnCheckoutSticky">Keks losschicken</button>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div class="modal" id="modal">
    <div class="modalCard" role="dialog" aria-modal="true" aria-label="Checkout">
      <div class="modalHd">
        <div>
          <div class="title" style="font-size:15px">Keks losschicken</div>
          <div class="muted" style="font-size:12px">Letzter Schritt. Ruhig, sauber.</div>
        </div>
        <button class="x" id="btnClose">×</button>
      </div>
      <div class="modalBd">
        <div class="summaryGrid">
          <div class="kv"><div class="k">Form</div><div class="v" id="kvShape">–</div></div>
          <div class="kv"><div class="k">Extras</div><div class="v" id="kvDeco">–</div></div>
          <div class="kv" style="grid-column:1/-1"><div class="k">Botschaft</div><div class="v" id="kvMsg">–</div></div>
        </div>

        <div class="hr"></div>

        <label for="addr">Adresse</label>
        <input id="addr" placeholder="Straße & Hausnr., PLZ Ort" />

        <div class="row" style="margin-top:12px; justify-content:space-between">
          <div class="fineprint">✓ Kein Abo ✓ Zur sicheren Zahlung (Stripe-Link)</div>
          <div class="row">
            <button class="btn ghost" id="btnBack">Zurück</button>
            <button class="btn primary" id="btnPay">Zur sicheren Zahlung</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Gespeichert.</div>

  <!-- Libs -->
  <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>

  <script>
    // ---------------------------------------
    // State (simple, appetizing, no rarity)
    // ---------------------------------------
    const SHAPES = [
      {id:"circle", label:"Kreis"},
      {id:"heart",  label:"Herz"},
      {id:"star",   label:"Stern"},
      {id:"smile",  label:"Smiley"},
      {id:"tree",   label:"Tannenbaum"},
    ];

    const DECOS = [
      {id:"sprinkles", label:"Sprinkles"},
      {id:"choco", label:"Schoko-Drizzle"},
      {id:"sugar", label:"Zuckerrand"},
    ];

    const TEMPLATES = [
      "Vermiss dich.",
      "Für dich.",
      "Meld dich.",
      "Du fehlst.",
      "Danke.",
      "Bin stolz auf dich."
    ];

    const HALL = [
      {id:"h1", label:"Beliebt", message:"Vermiss dich.", shape:"heart", deco:["sprinkles"]},
      {id:"h2", label:"Klassiker", message:"Für dich.", shape:"circle", deco:["sugar"]},
      {id:"h3", label:"Kurz & direkt", message:"Meld dich.", shape:"circle", deco:["choco"]},
      {id:"h4", label:"Warm", message:"Du fehlst.", shape:"heart", deco:["sprinkles","sugar"]},
    ];

    const LS_KEY = "onlykeks_index_soft_v2";

    let state = loadDraft() ?? {
      shape: "circle",
      deco: ["sprinkles"],
      message: ""
    };

    // ---------------------------------------
    // Elements
    // ---------------------------------------
    const $ = (s)=>document.querySelector(s);
    const msg = $("#msg");
    const count = $("#count");
    const templates = $("#templates");
    const shapeChips = $("#shapeChips");
    const decoChips = $("#decoChips");
    const hall = $("#hall");
    const shareUrl = $("#shareUrl");
    const toast = $("#toast");

    const btnCopy = $("#btnCopy");
    const btnShare = $("#btnShare");
    const btnSurprise = $("#btnSurprise");
    const btnReset = $("#btnReset");
    const btnScrollTop = $("#btnScrollTop");

    const modal = $("#modal");
    const btnCheckout = $("#btnCheckout");
    const btnCheckoutTop = $("#btnCheckoutTop");
    const btnCheckoutSticky = $("#btnCheckoutSticky");
    const btnClose = $("#btnClose");
    const btnBack = $("#btnBack");
    const btnPay = $("#btnPay");

    const kvShape = $("#kvShape");
    const kvDeco = $("#kvDeco");
    const kvMsg  = $("#kvMsg");
    const addr   = $("#addr");

    // ---------------------------------------
    // UI builders
    // ---------------------------------------
    function buildTemplates(){
      templates.innerHTML = "";
      TEMPLATES.forEach(t=>{
        const el = document.createElement("div");
        el.className = "tpl";
        el.textContent = t;
        el.onclick = ()=>{
          state.message = t;
          persist(); syncAll();
          toastMsg("Vorlage übernommen.");
        };
        templates.appendChild(el);
      });
    }

    function buildChips(){
      shapeChips.innerHTML = "";
      SHAPES.forEach(s=>{
        const el = document.createElement("div");
        el.className = "chip";
        el.textContent = s.label;
        el.dataset.id = s.id;
        el.onclick = ()=>{
          state.shape = s.id;
          persist(); syncAll();
        };
        shapeChips.appendChild(el);
      });

      decoChips.innerHTML = "";
      DECOS.forEach(d=>{
        const el = document.createElement("div");
        el.className = "chip";
        el.textContent = d.label;
        el.dataset.id = d.id;
        el.onclick = ()=>toggleDeco(d.id);
        decoChips.appendChild(el);
      });
    }

    function buildHall(){
      hall.innerHTML = "";
      HALL.forEach(h=>{
        const el = document.createElement("div");
        el.className = "hallItem";
        el.innerHTML = `
          <div class="hallTop">
            <div class="miniCookie" aria-hidden="true"></div>
            <div>
              <div class="t">${escapeHtml(h.label)}</div>
              <div class="m">„${escapeHtml(h.message)}“</div>
            </div>
          </div>
          <div class="tags">
            <span class="tag">${escapeHtml(shapeLabel(h.shape))}</span>
            ${h.deco.map(d=>`<span class="tag">${escapeHtml(decoLabel(d))}</span>`).join("")}
          </div>
        `;
        el.onclick = ()=>{
          state.shape = h.shape;
          state.deco = [...h.deco];
          state.message = h.message;
          persist(); syncAll();
          toastMsg("Hall-Keks geladen.");
        };
        hall.appendChild(el);
      });
    }

    function toggleDeco(id){
      const has = state.deco.includes(id);
      let next = has ? state.deco.filter(x=>x!==id) : [...state.deco, id];
      if(next.length > 2) next = next.slice(next.length-2); // max 2 extras
      state.deco = next;
      persist(); syncAll();
    }

    // ---------------------------------------
    // Persistence / Share
    // ---------------------------------------
    function persist(){
      localStorage.setItem(LS_KEY, JSON.stringify(state));
      toastMsg("Gespeichert.");
    }
    function loadDraft(){
      try{
        const raw = localStorage.getItem(LS_KEY);
        if(!raw) return null;
        return JSON.parse(raw);
      }catch(e){ return null; }
    }

    function encodeState(s){
      const json = JSON.stringify(s);
      return btoa(unescape(encodeURIComponent(json)));
    }
    function decodeState(str){
      const json = decodeURIComponent(escape(atob(str)));
      return JSON.parse(json);
    }
    function buildShareUrl(){
      const code = encodeState(state);
      const url = new URL(location.href);
      url.searchParams.set("share", code);
      return url.toString();
    }

    // ---------------------------------------
    // Sync
    // ---------------------------------------
    function syncAll(){
      // chips active
      [...shapeChips.children].forEach(c=>c.classList.toggle("on", c.dataset.id===state.shape));
      [...decoChips.children].forEach(c=>c.classList.toggle("on", state.deco.includes(c.dataset.id)));

      // message
      msg.value = state.message || "";
      count.textContent = (state.message || "").length;

      // share url
      shareUrl.value = buildShareUrl();

      // checkout summary
      kvShape.textContent = shapeLabel(state.shape);
      kvDeco.textContent = state.deco.length ? state.deco.map(decoLabel).join(", ") : "–";
      kvMsg.textContent  = (state.message && state.message.trim().length) ? state.message.trim() : "–";

      // update 3D
      updateCookieVisual();
    }

    function toastMsg(t){
      toast.textContent = t;
      toast.classList.add("on");
      clearTimeout(toast._t);
      toast._t = setTimeout(()=>toast.classList.remove("on"), 850);
    }

    function shapeLabel(id){
      const s = SHAPES.find(x=>x.id===id);
      return s ? s.label : id;
    }
    function decoLabel(id){
      const d = DECOS.find(x=>x.id===id);
      return d ? d.label : id;
    }
    function escapeHtml(s){ return (s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;" }[m])); }

    // ---------------------------------------
    // Events
    // ---------------------------------------
    msg.addEventListener("input", ()=>{
      state.message = (msg.value || "").slice(0,90);
      persist(); syncAll();
    });

    function copyLink(){
      shareUrl.select();
      document.execCommand("copy");
      toastMsg("Link kopiert.");
    }
    btnCopy.onclick = copyLink;
    btnShare.onclick = copyLink;

    btnSurprise.onclick = ()=>{
      const pickShape = SHAPES[Math.floor(Math.random()*SHAPES.length)].id;
      const pickDeco = [];
      const r = Math.random();
      if(r > .10) pickDeco.push(DECOS[Math.floor(Math.random()*DECOS.length)].id);
      if(r > .75) {
        const d2 = DECOS[Math.floor(Math.random()*DECOS.length)].id;
        if(!pickDeco.includes(d2)) pickDeco.push(d2);
      }
      state.shape = pickShape;
      state.deco = pickDeco;
      persist(); syncAll();
      toastMsg("Überraschung geladen.");
    };

    btnReset.onclick = ()=>{
      localStorage.removeItem(LS_KEY);
      state = { shape:"circle", deco:["sprinkles"], message:"" };
      persist(); syncAll();
    };

    btnScrollTop.onclick = ()=> window.scrollTo({top:0, behavior:"smooth"});

    // Modal
    function openModal(){ modal.classList.add("on"); addr.focus(); }
    function closeModal(){ modal.classList.remove("on"); }

    btnCheckout.onclick = openModal;
    btnCheckoutTop.onclick = openModal;
    btnCheckoutSticky.onclick = openModal;

    btnClose.onclick = closeModal;
    btnBack.onclick = closeModal;
    modal.addEventListener("click", (e)=>{ if(e.target === modal) closeModal(); });

    btnPay.onclick = ()=>{
      if(!addr.value.trim()){
        toastMsg("Adresse fehlt.");
        return;
      }
      toastMsg("Zahlung: Stripe-Link als nächster Schritt.");
      closeModal();
    };

    // Share loader
    (function initShare(){
      const p = new URLSearchParams(location.search);
      const share = p.get("share");
      if(!share) return;
      try{
        const incoming = decodeState(share);
        if(incoming && incoming.shape){
          state = {
            shape: incoming.shape,
            deco: Array.isArray(incoming.deco) ? incoming.deco : [],
            message: incoming.message ?? ""
          };
          persist();
          toastMsg("Share-Keks geladen.");
        }
      }catch(e){
        toastMsg("Share-Link ungültig.");
      }
    })();

    // ---------------------------------------
    // THREE.JS – Soft 3D Cookie (more "edible")
    // ---------------------------------------
    const canvas = document.getElementById("c");
    let renderer, scene, camera, cookieGroup, cookieMesh, icingMesh, sprinkles, drizzle, sugarRim, textSprite;
    let okWebGL = true;
    let dragging=false, lastX=0, spin=0;

    function initThree(){
      try{
        renderer = new THREE.WebGLRenderer({canvas, antialias:true, alpha:true, powerPreference:"high-performance"});
        renderer.setPixelRatio(Math.min(devicePixelRatio, 2));
        renderer.setSize(canvas.clientWidth, 460, false);

        scene = new THREE.Scene();

        camera = new THREE.PerspectiveCamera(33, canvas.clientWidth/460, 0.1, 100);
        camera.position.set(0, 1.05, 4.45);

        // warm, bakery lighting
        const hemi = new THREE.HemisphereLight(0xffffff, 0xf2e5d6, 1.10);
        scene.add(hemi);

        const key = new THREE.DirectionalLight(0xffffff, 1.15);
        key.position.set(2.4, 3.4, 2.4);
        scene.add(key);

        const fill = new THREE.DirectionalLight(0xfff1df, 0.60);
        fill.position.set(-2.8, 1.8, 1.4);
        scene.add(fill);

        const rim = new THREE.DirectionalLight(0xffffff, 0.25);
        rim.position.set(-2.0, 2.0, -2.4);
        scene.add(rim);

        cookieGroup = new THREE.Group();
        scene.add(cookieGroup);

        buildCookie();
        bindDrag();
        window.addEventListener("resize", onResize);
        animate();
      }catch(e){
        okWebGL = false;
        fallback2D();
      }
    }

    function onResize(){
      if(!renderer || !camera) return;
      const w = canvas.clientWidth;
      camera.aspect = w/460;
      camera.updateProjectionMatrix();
      renderer.setSize(w, 460, false);
    }

    function cssVar(name){
      return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
    }

    function buildCookie(){
      while(cookieGroup.children.length) cookieGroup.remove(cookieGroup.children[0]);

      // Base cookie
      const baseGeo = new THREE.CylinderGeometry(1.40, 1.40, 0.44, 64, 1, false);
      const cookieMat = new THREE.MeshStandardMaterial({
        color: new THREE.Color(cssVar("--cookie")),
        roughness: 0.95,
        metalness: 0.0
      });
      cookieMesh = new THREE.Mesh(baseGeo, cookieMat);
      cookieMesh.rotation.x = Math.PI * 0.085;
      cookieGroup.add(cookieMesh);

      // Icing
      const icingGeo = new THREE.CylinderGeometry(1.23, 1.23, 0.075, 64, 1, false);
      const icingMat = new THREE.MeshStandardMaterial({
        color: 0xF7F0E6,
        roughness: 0.60,
        metalness: 0.0,
        transparent:true,
        opacity: 0.97
      });
      icingMesh = new THREE.Mesh(icingGeo, icingMat);
      icingMesh.position.y = 0.235;
      icingMesh.rotation.x = cookieMesh.rotation.x;
      cookieGroup.add(icingMesh);

      // Extras
      sprinkles = makeSprinkles();
      cookieGroup.add(sprinkles);

      drizzle = makeDrizzle();
      cookieGroup.add(drizzle);

      sugarRim = makeSugarRim();
      cookieGroup.add(sugarRim);

      // Text
      textSprite = makeTextSprite();
      textSprite.position.set(0, 0.335, 0.02);
      textSprite.scale.set(2.30, 1.15, 1);
      cookieGroup.add(textSprite);

      applyShape();
      applyDecos();
      drawTextOnSprite(textSprite, state.message);
    }

    function makeSprinkles(){
      const count = 140;
      const geom = new THREE.BufferGeometry();
      const pos = new Float32Array(count*3);
      for(let i=0;i<count;i++){
        const a = Math.random()*Math.PI*2;
        const r = Math.sqrt(Math.random())*1.06;
        pos[i*3+0] = Math.cos(a)*r;
        pos[i*3+1] = 0.265 + (Math.random()*0.02);
        pos[i*3+2] = Math.sin(a)*r;
      }
      geom.setAttribute("position", new THREE.BufferAttribute(pos, 3));
      const mat = new THREE.PointsMaterial({
        size:0.05,
        color: new THREE.Color(cssVar("--accent")),
        transparent:true,
        opacity:0.92
      });
      const pts = new THREE.Points(geom, mat);
      pts.visible = false;
      return pts;
    }

    function makeDrizzle(){
      const group = new THREE.Group();
      const mat = new THREE.MeshStandardMaterial({ color: 0x5b3a22, roughness: 0.80, metalness: 0.0 });
      for(let i=0;i<3;i++){
        const geo = new THREE.TorusGeometry(0.80 + i*0.12, 0.03, 10, 70);
        const m = new THREE.Mesh(geo, mat);
        m.rotation.x = Math.PI/2 - 0.20;
        m.position.y = 0.272 + i*0.003;
        m.rotation.z = i*0.45;
        group.add(m);
      }
      group.visible = false;
      return group;
    }

    function makeSugarRim(){
      const count = 90;
      const geom = new THREE.BufferGeometry();
      const pos = new Float32Array(count*3);
      for(let i=0;i<count;i++){
        const a = (i/count)*Math.PI*2;
        const r = 1.17 + (Math.random()*0.01);
        pos[i*3+0] = Math.cos(a)*r;
        pos[i*3+1] = 0.265 + (Math.random()*0.01);
        pos[i*3+2] = Math.sin(a)*r;
      }
      geom.setAttribute("position", new THREE.BufferAttribute(pos, 3));
      const mat = new THREE.PointsMaterial({ size:0.045, color: 0xFFFFFF, transparent:true, opacity:0.78 });
      const pts = new THREE.Points(geom, mat);
      pts.visible = false;
      return pts;
    }

    function makeTextSprite(){
      const c = document.createElement("canvas");
      c.width = 1024; c.height = 512;
      const ctx = c.getContext("2d");
      ctx.clearRect(0,0,c.width,c.height);

      const tex = new THREE.CanvasTexture(c);
      tex.anisotropy = 4;
      const mat = new THREE.SpriteMaterial({ map: tex, transparent:true, opacity: 0.98 });
      const spr = new THREE.Sprite(mat);
      spr.userData._canvas = c;
      spr.userData._ctx = ctx;
      return spr;
    }

    function drawTextOnSprite(spr, text){
      const c = spr.userData._canvas;
      const ctx = spr.userData._ctx;
      ctx.clearRect(0,0,c.width,c.height);

      const t = (text || "").trim();
      const display = t.length ? t : " ";

      ctx.textAlign = "center";
      ctx.textBaseline = "middle";

      let size = 78;
      ctx.font = `950 ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      while(ctx.measureText(display).width > 900 && size > 46){
        size -= 2;
        ctx.font = `950 ${size}px system-ui, -apple-system, Segoe UI, Roboto, Arial`;
      }

      ctx.fillStyle = "rgba(30,26,22,.86)";
      ctx.fillText(display, c.width/2, c.height/2);

      spr.material.map.needsUpdate = true;
    }

    function applyShape(){
      const s = state.shape;
      cookieGroup.scale.set(1,1,1);
      cookieGroup.rotation.y = 0;

      if(s==="circle"){ cookieGroup.scale.set(1,1,1); }
      if(s==="heart"){ cookieGroup.scale.set(1.0,1.0,0.92); cookieGroup.rotation.y = 0.10; }
      if(s==="star"){ cookieGroup.scale.set(0.98,1.0,0.98); cookieGroup.rotation.y = 0.50; }
      if(s==="smile"){ cookieGroup.scale.set(1.02,1.0,0.95); cookieGroup.rotation.y = -0.16; }
      if(s==="tree"){ cookieGroup.scale.set(0.92,1.0,1.02); cookieGroup.rotation.y = 0.26; }
    }

    function applyDecos(){
      sprinkles.visible = state.deco.includes("sprinkles");
      drizzle.visible = state.deco.includes("choco");
      sugarRim.visible = state.deco.includes("sugar");
    }

    function updateCookieVisual(){
      if(!okWebGL) return;
      applyShape();
      applyDecos();
      drawTextOnSprite(textSprite, state.message);
    }

    function animate(){
      if(!okWebGL) return;
      requestAnimationFrame(animate);

      const t = performance.now()*0.001;

      // premium slow motion, plus user spin
      const auto = 0.0016;
      spin *= 0.92;
      cookieGroup.rotation.y += auto + spin;

      // subtle float
      cookieGroup.position.y = Math.sin(t*1.0)*0.02;

      renderer.render(scene, camera);
    }

    function bindDrag(){
      const el = canvas;
      const down = (x)=>{ dragging=true; lastX=x; };
      const move = (x)=>{
        if(!dragging) return;
        const dx = x - lastX;
        lastX = x;
        spin = dx * 0.00006; // gentle
      };
      const up = ()=>{ dragging=false; };

      el.addEventListener("mousedown",(e)=>down(e.clientX));
      window.addEventListener("mousemove",(e)=>move(e.clientX));
      window.addEventListener("mouseup",up);

      el.addEventListener("touchstart",(e)=>down(e.touches[0].clientX), {passive:true});
      el.addEventListener("touchmove",(e)=>move(e.touches[0].clientX), {passive:true});
      el.addEventListener("touchend",up);
    }

    function fallback2D(){
      const wrap = document.getElementById("stageWrap");
      wrap.innerHTML = `
        <div style="padding:18px; min-height:460px; display:flex; align-items:center; justify-content:center">
          <div style="width:280px;height:280px;border-radius:999px;background:radial-gradient(circle at 35% 35%, #ffe1c7, ${cssVar("--cookie")} 60%, #6d4a2a 120%);border:1px solid rgba(30,26,22,.10);box-shadow:0 24px 70px rgba(30,26,22,.16);display:flex;align-items:center;justify-content:center;text-align:center;padding:22px;font-weight:950;line-height:1.05;color:${cssVar("--ink")}">
            ${escapeHtml(state.message || " ")}
          </div>
        </div>
      `;
      toastMsg("3D nicht verfügbar – 2D Vorschau aktiv.");
    }

    // ---------------------------------------
    // Init
    // ---------------------------------------
    buildTemplates();
    buildChips();
    buildHall();
    syncAll();
    initThree();
  </script>
</body>
</html>
